<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                 #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE TupleSections       #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE DeriveDataTypeable  #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE DeriveFunctor       #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE DeriveGeneric       #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE StandaloneDeriving  #-}</span><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">UnliftIO.Internals.Async</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Concurrent</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier hs-var">threadDelay</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">getNumCapabilities</span><span class="hs-special">)</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Concurrent</span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">C</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Concurrent.Async</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Concurrent.Async</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">A</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Concurrent.STM</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span>        </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forever</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">liftM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">unless</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">void</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&gt;=&gt;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad.IO.Unlift</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Foldable</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">for_</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">traverse_</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Typeable</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.IORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">IORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">atomicWriteIORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="UnliftIO.Exception.html"><span class="hs-identifier">UnliftIO.Exception</span></a><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">UE</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-comment">-- For the implementation of Conc below, we do not want any of the</span><span>
</span><a name="line-28"></a><span class="hs-comment">-- smart async exception handling logic from UnliftIO.Exception, since</span><span>
</span><a name="line-29"></a><span class="hs-comment">-- (eg) we're low-level enough to need to explicit be throwing async</span><span>
</span><a name="line-30"></a><span class="hs-comment">-- exceptions synchronously.</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Control.Exception</span><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">E</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.Generics</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-cpp">#if MIN_VERSION_base(4,9,0)
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Semigroup</span><span>
</span><a name="line-36"></a><span class="hs-cpp">#else
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Monoid</span><span>              </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Alt</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><span class="hs-cpp">#endif
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Foldable</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Foldable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">toList</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Traversable</span><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Traversable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">for</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">traverse</span><span class="hs-special">)</span><span>
</span><a name="line-41"></a><span>
</span><a name="line-42"></a><span class="hs-comment">-- | Unlifted 'A.async'.</span><span>
</span><a name="line-43"></a><span class="hs-comment">--</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-45"></a><span class="hs-identifier">async</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073027"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679073027"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073028"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073027"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073028"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-46"></a><a name="async"><a href="UnliftIO.Internals.Async.html#async"><span class="hs-identifier">async</span></a></a><span> </span><a name="local-6989586621679073029"><a href="#local-6989586621679073029"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073030"><a href="#local-6989586621679073030"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.async</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073030"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073029"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-47"></a><span>
</span><a name="line-48"></a><span class="hs-comment">-- | Unlifted 'A.asyncBound'.</span><span>
</span><a name="line-49"></a><span class="hs-comment">--</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-51"></a><span class="hs-identifier">asyncBound</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073025"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679073025"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073026"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073025"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073026"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-52"></a><a name="asyncBound"><a href="UnliftIO.Internals.Async.html#asyncBound"><span class="hs-identifier">asyncBound</span></a></a><span> </span><a name="local-6989586621679073031"><a href="#local-6989586621679073031"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073032"><a href="#local-6989586621679073032"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.asyncBound</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073032"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073031"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-53"></a><span>
</span><a name="line-54"></a><span class="hs-comment">-- | Unlifted 'A.asyncOn'.</span><span>
</span><a name="line-55"></a><span class="hs-comment">--</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-57"></a><span class="hs-identifier">asyncOn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073023"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073023"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073024"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073023"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073024"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-58"></a><a name="asyncOn"><a href="UnliftIO.Internals.Async.html#asyncOn"><span class="hs-identifier">asyncOn</span></a></a><span> </span><a name="local-6989586621679073033"><a href="#local-6989586621679073033"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679073034"><a href="#local-6989586621679073034"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073035"><a href="#local-6989586621679073035"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.asyncOn</span><span> </span><a href="#local-6989586621679073033"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073035"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073034"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- | Unlifted 'A.asyncWithUnmask'.</span><span>
</span><a name="line-61"></a><span class="hs-comment">--</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-63"></a><span class="hs-identifier">asyncWithUnmask</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073020"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679073022"><a href="#local-6989586621679073022"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679073020"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073022"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073020"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073022"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073020"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073021"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073020"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073021"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-64"></a><a name="asyncWithUnmask"><a href="UnliftIO.Internals.Async.html#asyncWithUnmask"><span class="hs-identifier">asyncWithUnmask</span></a></a><span> </span><a name="local-6989586621679073036"><a href="#local-6989586621679073036"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-65"></a><span>  </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073037"><a href="#local-6989586621679073037"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.asyncWithUnmask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073038"><a href="#local-6989586621679073038"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073037"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073036"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073038"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073037"><span class="hs-identifier hs-var">run</span></a><span>
</span><a name="line-66"></a><span>
</span><a name="line-67"></a><span class="hs-comment">-- | Unlifted 'A.asyncOnWithUnmask'.</span><span>
</span><a name="line-68"></a><span class="hs-comment">--</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-70"></a><span class="hs-identifier">asyncOnWithUnmask</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073017"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679073019"><a href="#local-6989586621679073019"><span class="hs-identifier">b</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679073017"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073019"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073017"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073019"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073017"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073018"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073017"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073018"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-71"></a><a name="asyncOnWithUnmask"><a href="UnliftIO.Internals.Async.html#asyncOnWithUnmask"><span class="hs-identifier">asyncOnWithUnmask</span></a></a><span> </span><a name="local-6989586621679073039"><a href="#local-6989586621679073039"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679073040"><a href="#local-6989586621679073040"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-72"></a><span>  </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073041"><a href="#local-6989586621679073041"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.asyncOnWithUnmask</span><span> </span><a href="#local-6989586621679073039"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073042"><a href="#local-6989586621679073042"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073041"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073040"><span class="hs-identifier hs-var">m</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073042"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073041"><span class="hs-identifier hs-var">run</span></a><span>
</span><a name="line-73"></a><span>
</span><a name="line-74"></a><span class="hs-comment">-- | Unlifted 'A.withAsync'.</span><span>
</span><a name="line-75"></a><span class="hs-comment">--</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-77"></a><span class="hs-identifier">withAsync</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073014"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679073014"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073015"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073015"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073014"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073016"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073014"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073016"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-78"></a><a name="withAsync"><a href="UnliftIO.Internals.Async.html#withAsync"><span class="hs-identifier">withAsync</span></a></a><span> </span><a name="local-6989586621679073043"><a href="#local-6989586621679073043"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073044"><a href="#local-6989586621679073044"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073045"><a href="#local-6989586621679073045"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.withAsync</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073045"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073043"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073045"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073044"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>
</span><a name="line-80"></a><span class="hs-comment">-- | Unlifted 'A.withAsyncBound'.</span><span>
</span><a name="line-81"></a><span class="hs-comment">--</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-83"></a><span class="hs-identifier">withAsyncBound</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073011"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679073011"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073012"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073012"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073011"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073013"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073011"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073013"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-84"></a><a name="withAsyncBound"><a href="UnliftIO.Internals.Async.html#withAsyncBound"><span class="hs-identifier">withAsyncBound</span></a></a><span> </span><a name="local-6989586621679073046"><a href="#local-6989586621679073046"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073047"><a href="#local-6989586621679073047"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073048"><a href="#local-6989586621679073048"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.withAsyncBound</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073048"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073046"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073048"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073047"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">-- | Unlifted 'A.withAsyncOn'.</span><span>
</span><a name="line-87"></a><span class="hs-comment">--</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-89"></a><span class="hs-identifier">withAsyncOn</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073008"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073008"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073009"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073009"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073008"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073010"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073008"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073010"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-90"></a><a name="withAsyncOn"><a href="UnliftIO.Internals.Async.html#withAsyncOn"><span class="hs-identifier">withAsyncOn</span></a></a><span> </span><a name="local-6989586621679073049"><a href="#local-6989586621679073049"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679073050"><a href="#local-6989586621679073050"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073051"><a href="#local-6989586621679073051"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073052"><a href="#local-6989586621679073052"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.withAsyncOn</span><span> </span><a href="#local-6989586621679073049"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073052"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073050"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073052"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073051"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">-- | Unlifted 'A.withAsyncWithUnmask'.</span><span>
</span><a name="line-93"></a><span class="hs-comment">--</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-95"></a><span class="hs-identifier">withAsyncWithUnmask</span><span>
</span><a name="line-96"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073004"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-97"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679073007"><a href="#local-6989586621679073007"><span class="hs-identifier">c</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679073004"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073007"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073004"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073007"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073004"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073005"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-98"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073005"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073004"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073006"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073004"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073006"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-100"></a><a name="withAsyncWithUnmask"><a href="UnliftIO.Internals.Async.html#withAsyncWithUnmask"><span class="hs-identifier">withAsyncWithUnmask</span></a></a><span> </span><a name="local-6989586621679073053"><a href="#local-6989586621679073053"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073054"><a href="#local-6989586621679073054"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-101"></a><span>  </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073055"><a href="#local-6989586621679073055"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.withAsyncWithUnmask</span><span>
</span><a name="line-102"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679073056"><a href="#local-6989586621679073056"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073055"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073053"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073056"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073055"><span class="hs-identifier hs-var">run</span></a><span class="hs-special">)</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621679073055"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073054"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-104"></a><span>
</span><a name="line-105"></a><span class="hs-comment">-- | Unlifted 'A.withAsyncOnWithMask'.</span><span>
</span><a name="line-106"></a><span class="hs-comment">--</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-108"></a><span class="hs-identifier">withAsyncOnWithUnmask</span><span>
</span><a name="line-109"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679073000"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-110"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679073003"><a href="#local-6989586621679073003"><span class="hs-identifier">c</span></a></a><span class="hs-operator">.</span><span> </span><a href="#local-6989586621679073000"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073003"><span class="hs-identifier hs-type">c</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073000"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073003"><span class="hs-identifier hs-type">c</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073000"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073001"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679073001"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073000"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073002"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073000"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073002"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-114"></a><a name="withAsyncOnWithUnmask"><a href="UnliftIO.Internals.Async.html#withAsyncOnWithUnmask"><span class="hs-identifier">withAsyncOnWithUnmask</span></a></a><span> </span><a name="local-6989586621679073057"><a href="#local-6989586621679073057"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-6989586621679073058"><a href="#local-6989586621679073058"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073059"><a href="#local-6989586621679073059"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-115"></a><span>  </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073060"><a href="#local-6989586621679073060"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.withAsyncOnWithUnmask</span><span> </span><a href="#local-6989586621679073057"><span class="hs-identifier hs-var">i</span></a><span>
</span><a name="line-116"></a><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679073061"><a href="#local-6989586621679073061"><span class="hs-identifier">unmask</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073060"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073058"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073061"><span class="hs-identifier hs-var">unmask</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073060"><span class="hs-identifier hs-var">run</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>    </span><span class="hs-special">(</span><a href="#local-6989586621679073060"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073059"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span class="hs-comment">-- | Lifted 'A.wait'.</span><span>
</span><a name="line-120"></a><span class="hs-comment">--</span><span>
</span><a name="line-121"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-122"></a><span class="hs-identifier">wait</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072998"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072999"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072998"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072999"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-123"></a><a name="wait"><a href="UnliftIO.Internals.Async.html#wait"><span class="hs-identifier">wait</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.wait</span><span>
</span><a name="line-124"></a><span>
</span><a name="line-125"></a><span class="hs-comment">-- | Lifted 'A.poll'.</span><span>
</span><a name="line-126"></a><span class="hs-comment">--</span><span>
</span><a name="line-127"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-128"></a><span class="hs-identifier">poll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072996"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072997"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072996"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679072997"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-129"></a><a name="poll"><a href="UnliftIO.Internals.Async.html#poll"><span class="hs-identifier">poll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.poll</span><span>
</span><a name="line-130"></a><span>
</span><a name="line-131"></a><span class="hs-comment">-- | Lifted 'A.waitCatch'.</span><span>
</span><a name="line-132"></a><span class="hs-comment">--</span><span>
</span><a name="line-133"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-134"></a><span class="hs-identifier">waitCatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072994"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072995"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072994"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679072995"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-135"></a><a name="waitCatch"><a href="UnliftIO.Internals.Async.html#waitCatch"><span class="hs-identifier">waitCatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.waitCatch</span><span>
</span><a name="line-136"></a><span>
</span><a name="line-137"></a><span class="hs-comment">-- | Lifted 'A.cancel'.</span><span>
</span><a name="line-138"></a><span class="hs-comment">--</span><span>
</span><a name="line-139"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-140"></a><span class="hs-identifier">cancel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072992"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072993"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072992"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-141"></a><a name="cancel"><a href="UnliftIO.Internals.Async.html#cancel"><span class="hs-identifier">cancel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.cancel</span><span>
</span><a name="line-142"></a><span>
</span><a name="line-143"></a><span class="hs-comment">-- | Lifted 'A.uninterruptibleCancel'.</span><span>
</span><a name="line-144"></a><span class="hs-comment">--</span><span>
</span><a name="line-145"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-146"></a><span class="hs-identifier">uninterruptibleCancel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072990"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072991"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072990"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-147"></a><a name="uninterruptibleCancel"><a href="UnliftIO.Internals.Async.html#uninterruptibleCancel"><span class="hs-identifier">uninterruptibleCancel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.uninterruptibleCancel</span><span>
</span><a name="line-148"></a><span>
</span><a name="line-149"></a><span class="hs-comment">-- | Lifted 'A.cancelWith'. Additionally uses 'UE.toAsyncException' to</span><span>
</span><a name="line-150"></a><span class="hs-comment">-- ensure async exception safety.</span><span>
</span><a name="line-151"></a><span class="hs-comment">--</span><span>
</span><a name="line-152"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-153"></a><span class="hs-identifier">cancelWith</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exception</span><span> </span><a href="#local-6989586621679072987"><span class="hs-identifier hs-type">e</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072988"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072989"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072987"><span class="hs-identifier hs-type">e</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072988"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-154"></a><a name="cancelWith"><a href="UnliftIO.Internals.Async.html#cancelWith"><span class="hs-identifier">cancelWith</span></a></a><span> </span><a name="local-6989586621679073062"><a href="#local-6989586621679073062"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073063"><a href="#local-6989586621679073063"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.cancelWith</span><span> </span><a href="#local-6989586621679073062"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Exception.html#toAsyncException"><span class="hs-identifier hs-var">UE.toAsyncException</span></a><span> </span><a href="#local-6989586621679073063"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span>
</span><a name="line-156"></a><span class="hs-comment">-- | Lifted 'A.waitAny'.</span><span>
</span><a name="line-157"></a><span class="hs-comment">--</span><span>
</span><a name="line-158"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-159"></a><span class="hs-identifier">waitAny</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072985"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072986"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072985"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072986"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679072986"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-160"></a><a name="waitAny"><a href="UnliftIO.Internals.Async.html#waitAny"><span class="hs-identifier">waitAny</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.waitAny</span><span>
</span><a name="line-161"></a><span>
</span><a name="line-162"></a><span class="hs-comment">-- | Lifted 'A.waitAnyCatch'.</span><span>
</span><a name="line-163"></a><span class="hs-comment">--</span><span>
</span><a name="line-164"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-165"></a><span class="hs-identifier">waitAnyCatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072983"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072984"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072983"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072984"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679072984"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><a name="waitAnyCatch"><a href="UnliftIO.Internals.Async.html#waitAnyCatch"><span class="hs-identifier">waitAnyCatch</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.waitAnyCatch</span><span>
</span><a name="line-167"></a><span>
</span><a name="line-168"></a><span class="hs-comment">-- | Lifted 'A.waitAnyCancel'.</span><span>
</span><a name="line-169"></a><span class="hs-comment">--</span><span>
</span><a name="line-170"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-171"></a><span class="hs-identifier">waitAnyCancel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072981"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072982"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072981"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072982"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679072982"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><a name="waitAnyCancel"><a href="UnliftIO.Internals.Async.html#waitAnyCancel"><span class="hs-identifier">waitAnyCancel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.waitAnyCancel</span><span>
</span><a name="line-173"></a><span>
</span><a name="line-174"></a><span class="hs-comment">-- | Lifted 'A.waitAnyCatchCancel'.</span><span>
</span><a name="line-175"></a><span class="hs-comment">--</span><span>
</span><a name="line-176"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-177"></a><span class="hs-identifier">waitAnyCatchCancel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072979"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072980"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072979"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072980"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679072980"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-178"></a><a name="waitAnyCatchCancel"><a href="UnliftIO.Internals.Async.html#waitAnyCatchCancel"><span class="hs-identifier">waitAnyCatchCancel</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.waitAnyCatchCancel</span><span>
</span><a name="line-179"></a><span>
</span><a name="line-180"></a><span class="hs-comment">-- | Lifted 'A.waitEither'.</span><span>
</span><a name="line-181"></a><span class="hs-comment">--</span><span>
</span><a name="line-182"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-183"></a><span class="hs-identifier">waitEither</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072976"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072977"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072978"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072976"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679072977"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679072978"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-184"></a><a name="waitEither"><a href="UnliftIO.Internals.Async.html#waitEither"><span class="hs-identifier">waitEither</span></a></a><span> </span><a name="local-6989586621679073064"><a href="#local-6989586621679073064"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073065"><a href="#local-6989586621679073065"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.waitEither</span><span> </span><a href="#local-6989586621679073064"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073065"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span>
</span><a name="line-186"></a><span class="hs-comment">-- | Lifted 'A.waitEitherCatch'.</span><span>
</span><a name="line-187"></a><span class="hs-comment">--</span><span>
</span><a name="line-188"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-189"></a><span class="hs-identifier">waitEitherCatch</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072973"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072974"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072975"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072973"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679072974"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679072975"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-190"></a><a name="waitEitherCatch"><a href="UnliftIO.Internals.Async.html#waitEitherCatch"><span class="hs-identifier">waitEitherCatch</span></a></a><span> </span><a name="local-6989586621679073066"><a href="#local-6989586621679073066"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073067"><a href="#local-6989586621679073067"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.waitEitherCatch</span><span> </span><a href="#local-6989586621679073066"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073067"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span>
</span><a name="line-192"></a><span class="hs-comment">-- | Lifted 'A.waitEitherCancel'.</span><span>
</span><a name="line-193"></a><span class="hs-comment">--</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-195"></a><span class="hs-identifier">waitEitherCancel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072970"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072971"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072972"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072970"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679072971"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679072972"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><a name="waitEitherCancel"><a href="UnliftIO.Internals.Async.html#waitEitherCancel"><span class="hs-identifier">waitEitherCancel</span></a></a><span> </span><a name="local-6989586621679073068"><a href="#local-6989586621679073068"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073069"><a href="#local-6989586621679073069"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.waitEitherCancel</span><span> </span><a href="#local-6989586621679073068"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073069"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-197"></a><span>
</span><a name="line-198"></a><span class="hs-comment">-- | Lifted 'A.waitEitherCatchCancel'.</span><span>
</span><a name="line-199"></a><span class="hs-comment">--</span><span>
</span><a name="line-200"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-201"></a><span class="hs-identifier">waitEitherCatchCancel</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072967"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072968"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072969"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072967"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679072968"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><a href="#local-6989586621679072969"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><a name="waitEitherCatchCancel"><a href="UnliftIO.Internals.Async.html#waitEitherCatchCancel"><span class="hs-identifier">waitEitherCatchCancel</span></a></a><span> </span><a name="local-6989586621679073070"><a href="#local-6989586621679073070"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073071"><a href="#local-6989586621679073071"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.waitEitherCatchCancel</span><span> </span><a href="#local-6989586621679073070"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073071"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-203"></a><span>
</span><a name="line-204"></a><span class="hs-comment">-- | Lifted 'A.waitEither_'.</span><span>
</span><a name="line-205"></a><span class="hs-comment">--</span><span>
</span><a name="line-206"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-207"></a><span class="hs-identifier">waitEither_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072964"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072965"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072966"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072964"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-208"></a><a name="waitEither_"><a href="UnliftIO.Internals.Async.html#waitEither_"><span class="hs-identifier">waitEither_</span></a></a><span> </span><a name="local-6989586621679073072"><a href="#local-6989586621679073072"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073073"><a href="#local-6989586621679073073"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.waitEither_</span><span> </span><a href="#local-6989586621679073072"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073073"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-comment">-- | Lifted 'A.waitBoth'.</span><span>
</span><a name="line-211"></a><span class="hs-comment">--</span><span>
</span><a name="line-212"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-213"></a><span class="hs-identifier">waitBoth</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072961"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072962"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072963"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072961"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072962"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679072963"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-214"></a><a name="waitBoth"><a href="UnliftIO.Internals.Async.html#waitBoth"><span class="hs-identifier">waitBoth</span></a></a><span> </span><a name="local-6989586621679073074"><a href="#local-6989586621679073074"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073075"><a href="#local-6989586621679073075"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.waitBoth</span><span> </span><a href="#local-6989586621679073074"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073075"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-215"></a><span>
</span><a name="line-216"></a><span class="hs-comment">-- | Lifted 'A.link'.</span><span>
</span><a name="line-217"></a><span class="hs-comment">--</span><span>
</span><a name="line-218"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-219"></a><span class="hs-identifier">link</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072959"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072960"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072959"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><a name="link"><a href="UnliftIO.Internals.Async.html#link"><span class="hs-identifier">link</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">A.link</span><span>
</span><a name="line-221"></a><span>
</span><a name="line-222"></a><span class="hs-comment">-- | Lifted 'A.link2'.</span><span>
</span><a name="line-223"></a><span class="hs-comment">--</span><span>
</span><a name="line-224"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-225"></a><span class="hs-identifier">link2</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679072956"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072957"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Async</span><span> </span><a href="#local-6989586621679072958"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072956"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-226"></a><a name="link2"><a href="UnliftIO.Internals.Async.html#link2"><span class="hs-identifier">link2</span></a></a><span> </span><a name="local-6989586621679073076"><a href="#local-6989586621679073076"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073077"><a href="#local-6989586621679073077"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">A.link2</span><span> </span><a href="#local-6989586621679073076"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073077"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-227"></a><span>
</span><a name="line-228"></a><span class="hs-comment">-- | Unlifted 'A.race'.</span><span>
</span><a name="line-229"></a><span class="hs-comment">--</span><span>
</span><a name="line-230"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-231"></a><span class="hs-identifier">race</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072953"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679072953"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072954"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072953"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072955"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072953"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Either</span><span> </span><a href="#local-6989586621679072954"><span class="hs-identifier hs-type">a</span></a><span> </span><a href="#local-6989586621679072955"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-232"></a><a name="race"><a href="UnliftIO.Internals.Async.html#race"><span class="hs-identifier">race</span></a></a><span> </span><a name="local-6989586621679073078"><a href="#local-6989586621679073078"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073079"><a href="#local-6989586621679073079"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073080"><a href="#local-6989586621679073080"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.race</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073080"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073078"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073080"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073079"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-233"></a><span>
</span><a name="line-234"></a><span class="hs-comment">-- | Unlifted 'A.race_'.</span><span>
</span><a name="line-235"></a><span class="hs-comment">--</span><span>
</span><a name="line-236"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-237"></a><span class="hs-identifier">race_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072950"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679072950"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072951"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072950"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072952"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072950"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-238"></a><a name="race_"><a href="UnliftIO.Internals.Async.html#race_"><span class="hs-identifier">race_</span></a></a><span> </span><a name="local-6989586621679073081"><a href="#local-6989586621679073081"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073082"><a href="#local-6989586621679073082"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073083"><a href="#local-6989586621679073083"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.race_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073083"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073081"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073083"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073082"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-239"></a><span>
</span><a name="line-240"></a><span class="hs-comment">-- | Unlifted 'A.concurrently'.</span><span>
</span><a name="line-241"></a><span class="hs-comment">--</span><span>
</span><a name="line-242"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-243"></a><span class="hs-identifier">concurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072947"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679072947"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072948"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072947"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072949"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072947"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072948"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679072949"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-244"></a><a name="concurrently"><a href="UnliftIO.Internals.Async.html#concurrently"><span class="hs-identifier">concurrently</span></a></a><span> </span><a name="local-6989586621679073084"><a href="#local-6989586621679073084"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073085"><a href="#local-6989586621679073085"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073086"><a href="#local-6989586621679073086"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.concurrently</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073086"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073084"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073086"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073085"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">-- | Unlifted 'A.concurrently_'.</span><span>
</span><a name="line-247"></a><span class="hs-comment">--</span><span>
</span><a name="line-248"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-249"></a><span class="hs-identifier">concurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072944"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679072944"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072945"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072944"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072946"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072944"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-250"></a><a name="concurrently_"><a href="UnliftIO.Internals.Async.html#concurrently_"><span class="hs-identifier">concurrently_</span></a></a><span> </span><a name="local-6989586621679073087"><a href="#local-6989586621679073087"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073088"><a href="#local-6989586621679073088"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073089"><a href="#local-6989586621679073089"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">A.concurrently_</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073089"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073087"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073089"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073088"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-comment">-- | Unlifted 'A.Concurrently'.</span><span>
</span><a name="line-253"></a><span class="hs-comment">--</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-255"></a><span class="hs-keyword">newtype</span><span> </span><a name="Concurrently"><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier">Concurrently</span></a></a><span> </span><a name="local-6989586621679072255"><a href="#local-6989586621679072255"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679072256"><a href="#local-6989586621679072256"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Concurrently"><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier">Concurrently</span></a></a><span>
</span><a name="line-256"></a><span>  </span><span class="hs-special">{</span><span> </span><a name="runConcurrently"><a href="UnliftIO.Internals.Async.html#runConcurrently"><span class="hs-identifier">runConcurrently</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679072255"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072256"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-257"></a><span>  </span><span class="hs-special">}</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-comment">-- | @since 0.1.0.0</span><span>
</span><a name="line-260"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Monad</span><span> </span><a href="#local-6989586621679072858"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-type">Concurrently</span></a><span> </span><a href="#local-6989586621679072858"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-261"></a><span>  </span><a name="local-3458764513820541101"><span class="hs-identifier">fmap</span></a><span> </span><a name="local-6989586621679072859"><a href="#local-6989586621679072859"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><a name="local-6989586621679072860"><a href="#local-6989586621679072860"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><a href="#local-6989586621679072859"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679072860"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-comment">-- | @since 0.1.0.0</span><span>
</span><a name="line-264"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072853"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-type">Concurrently</span></a><span> </span><a href="#local-6989586621679072853"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-265"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">return</span><span>
</span><a name="line-266"></a><span>  </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><a name="local-6989586621679072854"><a href="#local-6989586621679072854"><span class="hs-identifier">fs</span></a></a><span> </span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span> </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-267"></a><span>    </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679072856"><a href="#local-6989586621679072856"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679072857"><a href="#local-6989586621679072857"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072856"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679072857"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#concurrently"><span class="hs-identifier hs-var">concurrently</span></a><span> </span><a href="#local-6989586621679072854"><span class="hs-identifier hs-var">fs</span></a><span> </span><span class="hs-keyword">as</span><span class="hs-special">)</span><span>
</span><a name="line-268"></a><span>
</span><a name="line-269"></a><span class="hs-comment">-- | Composing two unlifted 'Concurrently' values using 'Alternative' is the</span><span>
</span><a name="line-270"></a><span class="hs-comment">-- equivalent to using a 'race' combinator, the asynchrounous sub-routine that</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- returns a value first is the one that gets it's value returned, the slowest</span><span>
</span><a name="line-272"></a><span class="hs-comment">-- sub-routine gets cancelled and it's thread is killed.</span><span>
</span><a name="line-273"></a><span class="hs-comment">--</span><span>
</span><a name="line-274"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-275"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072280"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Alternative</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-type">Concurrently</span></a><span> </span><a href="#local-6989586621679072280"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-276"></a><span>  </span><span class="hs-comment">-- | Care should be taken when using the 'empty' value of the 'Alternative'</span><span>
</span><a name="line-277"></a><span>  </span><span class="hs-comment">-- interface, as it will create a thread that delays for a long period of</span><span>
</span><a name="line-278"></a><span>  </span><span class="hs-comment">-- time. The reason behind this implementation is that any other computation</span><span>
</span><a name="line-279"></a><span>  </span><span class="hs-comment">-- will finish first than the 'empty' value. This implementation is less than</span><span>
</span><a name="line-280"></a><span>  </span><span class="hs-comment">-- ideal, and in a perfect world, we would have a typeclass family that allows</span><span>
</span><a name="line-281"></a><span>  </span><span class="hs-comment">-- '(&lt;|&gt;)' but not 'empty'.</span><span>
</span><a name="line-282"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-283"></a><span>  </span><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-284"></a><span>  </span><a name="local-8214565720323790513"><span class="hs-identifier">empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">forever</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">threadDelay</span><span> </span><span class="hs-identifier hs-var">maxBound</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-285"></a><span>  </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a name="local-8214565720323790512"><span class="hs-operator">&lt;|&gt;</span></a><span> </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><a name="local-6989586621679072852"><a href="#local-6989586621679072852"><span class="hs-identifier">bs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-286"></a><span>    </span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-var">Concurrently</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">liftM</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-identifier hs-var">id</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#race"><span class="hs-identifier hs-var">race</span></a><span> </span><span class="hs-keyword">as</span><span> </span><a href="#local-6989586621679072852"><span class="hs-identifier hs-var">bs</span></a><span class="hs-special">)</span><span>
</span><a name="line-287"></a><span>
</span><a name="line-288"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-289"></a><span class="hs-cpp">#if MIN_VERSION_base(4,9,0)
</span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-291"></a><span class="hs-comment">-- | Only defined by @async@ for @base &gt;= 4.9@.</span><span>
</span><a name="line-292"></a><span class="hs-comment">--</span><span>
</span><a name="line-293"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-294"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072278"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="#local-6989586621679072279"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-type">Concurrently</span></a><span> </span><a href="#local-6989586621679072278"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072279"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-295"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftA2</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-296"></a><span>
</span><a name="line-297"></a><span class="hs-comment">-- | @since 0.1.0.0</span><span>
</span><a name="line-298"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="#local-6989586621679072276"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="#local-6989586621679072276"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072277"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Concurrently"><span class="hs-identifier hs-type">Concurrently</span></a><span> </span><a href="#local-6989586621679072277"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072276"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-299"></a><span>  </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-300"></a><span>  </span><a name="local-3458764513820541484"><span class="hs-identifier">mappend</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-301"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-302"></a><span class="hs-cpp">#else
</span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-304"></a><span class="hs-comment">-- | @since 0.1.0.0</span><span>
</span><a name="line-305"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MonadUnliftIO</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Monoid</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Concurrently</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-306"></a><span>  </span><span class="hs-identifier">mempty</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">pure</span><span> </span><span class="hs-identifier">mempty</span><span>
</span><a name="line-307"></a><span>  </span><span class="hs-identifier">mappend</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">liftA2</span><span> </span><span class="hs-identifier">mappend</span><span>
</span><a name="line-308"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-309"></a><span class="hs-cpp">#endif
</span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-311"></a><span>
</span><a name="line-312"></a><span class="hs-comment">-- | Similar to 'mapConcurrently' but with arguments flipped</span><span>
</span><a name="line-313"></a><span class="hs-comment">--</span><span>
</span><a name="line-314"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-315"></a><span class="hs-identifier">forConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072940"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679072941"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679072941"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072942"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072942"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072940"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072943"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072940"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072941"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072943"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-316"></a><a name="forConcurrently"><a href="UnliftIO.Internals.Async.html#forConcurrently"><span class="hs-identifier">forConcurrently</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="UnliftIO.Internals.Async.html#mapConcurrently"><span class="hs-identifier hs-var">mapConcurrently</span></a><span>
</span><a name="line-317"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">forConcurrently</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-318"></a><span>
</span><a name="line-319"></a><span class="hs-comment">-- | Similar to 'mapConcurrently_' but with arguments flipped</span><span>
</span><a name="line-320"></a><span class="hs-comment">--</span><span>
</span><a name="line-321"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-322"></a><span class="hs-identifier">forConcurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072936"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679072937"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679072937"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679072938"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072938"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072936"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072939"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072936"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-323"></a><a name="forConcurrently_"><a href="UnliftIO.Internals.Async.html#forConcurrently_"><span class="hs-identifier">forConcurrently_</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="UnliftIO.Internals.Async.html#mapConcurrently_"><span class="hs-identifier hs-var">mapConcurrently_</span></a><span>
</span><a name="line-324"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">forConcurrently_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-325"></a><span>
</span><a name="line-326"></a><span class="hs-comment">-- | Unlifted 'A.replicateConcurrently'.</span><span>
</span><a name="line-327"></a><span class="hs-comment">--</span><span>
</span><a name="line-328"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-329"></a><span class="hs-cpp">#if MIN_VERSION_base(4,7,0)
#else
</span><span class="hs-identifier">replicateConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Functor</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">MonadUnliftIO</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span>
</span><a name="line-332"></a><span class="hs-cpp">#endif
</span><a name="replicateConcurrently"><a href="UnliftIO.Internals.Async.html#replicateConcurrently"><span class="hs-identifier">replicateConcurrently</span></a></a><span> </span><a name="local-6989586621679073090"><a href="#local-6989586621679073090"><span class="hs-identifier">cnt</span></a></a><span> </span><a name="local-6989586621679073091"><a href="#local-6989586621679073091"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-334"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621679073090"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-335"></a><span>    </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-336"></a><span>    </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679073091"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-337"></a><span>    </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#mapConcurrently"><span class="hs-identifier hs-var">mapConcurrently</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621679073090"><span class="hs-identifier hs-var">cnt</span></a><span> </span><a href="#local-6989586621679073091"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">replicateConcurrently</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-339"></a><span>
</span><a name="line-340"></a><span class="hs-comment">-- | Unlifted 'A.replicateConcurrently_'.</span><span>
</span><a name="line-341"></a><span class="hs-comment">--</span><span>
</span><a name="line-342"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-343"></a><span class="hs-cpp">#if MIN_VERSION_base(4,7,0)
</span><span class="hs-identifier">replicateConcurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="#local-6989586621679072934"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072934"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072934"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072935"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072934"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-345"></a><span class="hs-cpp">#else
</span><span class="hs-identifier">replicateConcurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">MonadUnliftIO</span><span> </span><span class="hs-identifier">m</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-347"></a><span class="hs-cpp">#endif
</span><a name="replicateConcurrently_"><a href="UnliftIO.Internals.Async.html#replicateConcurrently_"><span class="hs-identifier">replicateConcurrently_</span></a></a><span> </span><a name="local-6989586621679073287"><a href="#local-6989586621679073287"><span class="hs-identifier">cnt</span></a></a><span> </span><a name="local-6989586621679073288"><a href="#local-6989586621679073288"><span class="hs-identifier">m</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-349"></a><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">compare</span><span> </span><a href="#local-6989586621679073287"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-350"></a><span>    </span><span class="hs-identifier hs-var">LT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-351"></a><span>    </span><span class="hs-identifier hs-var">EQ</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><a href="#local-6989586621679073288"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-352"></a><span>    </span><span class="hs-identifier hs-var">GT</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#mapConcurrently_"><span class="hs-identifier hs-var">mapConcurrently_</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">replicate</span><span> </span><a href="#local-6989586621679073287"><span class="hs-identifier hs-var">cnt</span></a><span> </span><a href="#local-6989586621679073288"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-353"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">replicateConcurrently_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-354"></a><span>
</span><a name="line-355"></a><span class="hs-comment">-- Conc uses GHC features that are not supported in versions &lt;= to ghc-7.10</span><span>
</span><a name="line-356"></a><span class="hs-comment">-- so we are going to export/use it when we have a higher version only.</span><span>
</span><a name="line-357"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-358"></a><span class="hs-cpp">#if MIN_VERSION_base(4,8,0)
</span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-360"></a><span>
</span><a name="line-361"></a><span class="hs-comment">-- | Executes a 'Traversable' container of items concurrently, it uses the 'Flat'</span><span>
</span><a name="line-362"></a><span class="hs-comment">-- type internally.</span><span>
</span><a name="line-363"></a><span class="hs-comment">--</span><span>
</span><a name="line-364"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-365"></a><span class="hs-identifier">mapConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072930"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679072931"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072932"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072930"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072933"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072931"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072932"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072930"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072931"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072933"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-366"></a><a name="mapConcurrently"><a href="UnliftIO.Internals.Async.html#mapConcurrently"><span class="hs-identifier">mapConcurrently</span></a></a><span> </span><a name="local-6989586621679073289"><a href="#local-6989586621679073289"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073290"><a href="#local-6989586621679073290"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073291"><a href="#local-6989586621679073291"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#runFlat"><span class="hs-identifier hs-var">runFlat</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">traverse</span><span>
</span><a name="line-367"></a><span>  </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatAction"><span class="hs-identifier hs-var">FlatAction</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073291"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073289"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-368"></a><span>  </span><a href="#local-6989586621679073290"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-369"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mapConcurrently</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-370"></a><span>
</span><a name="line-371"></a><span class="hs-comment">-- | Executes a 'Traversable' container of items concurrently, it uses the 'Flat'</span><span>
</span><a name="line-372"></a><span class="hs-comment">-- type internally. This function ignores the results.</span><span>
</span><a name="line-373"></a><span class="hs-comment">--</span><span>
</span><a name="line-374"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-375"></a><span class="hs-identifier">mapConcurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072926"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679072927"><span class="hs-identifier hs-type">f</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072928"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072926"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072929"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072927"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679072928"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072926"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-376"></a><a name="mapConcurrently_"><a href="UnliftIO.Internals.Async.html#mapConcurrently_"><span class="hs-identifier">mapConcurrently_</span></a></a><span> </span><a name="local-6989586621679073292"><a href="#local-6989586621679073292"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073293"><a href="#local-6989586621679073293"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073294"><a href="#local-6989586621679073294"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#runFlat"><span class="hs-identifier hs-var">runFlat</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">traverse_</span><span>
</span><a name="line-377"></a><span>  </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatAction"><span class="hs-identifier hs-var">FlatAction</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073294"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073292"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>  </span><a href="#local-6989586621679073293"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-379"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mapConcurrently_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-380"></a><span>
</span><a name="line-381"></a><span>
</span><a name="line-382"></a><span class="hs-comment">-- More efficient Conc implementation</span><span>
</span><a name="line-383"></a><span>
</span><a name="line-384"></a><span class="hs-comment">-- | A more efficient alternative to 'Concurrently', which reduces the</span><span>
</span><a name="line-385"></a><span class="hs-comment">-- number of threads that need to be forked. For more information, see</span><span>
</span><a name="line-386"></a><span class="hs-comment">-- @FIXME link to blog post@. This is provided as a separate type to</span><span>
</span><a name="line-387"></a><span class="hs-comment">-- @Concurrently@ as it has a slightly different API.</span><span>
</span><a name="line-388"></a><span class="hs-comment">--</span><span>
</span><a name="line-389"></a><span class="hs-comment">-- Use the 'conc' function to construct values of type 'Conc', and</span><span>
</span><a name="line-390"></a><span class="hs-comment">-- 'runConc' to execute the composed actions. You can use the</span><span>
</span><a name="line-391"></a><span class="hs-comment">-- @Applicative@ instance to run different actions and wait for all of</span><span>
</span><a name="line-392"></a><span class="hs-comment">-- them to complete, or the @Alternative@ instance to wait for the</span><span>
</span><a name="line-393"></a><span class="hs-comment">-- first thread to complete.</span><span>
</span><a name="line-394"></a><span class="hs-comment">--</span><span>
</span><a name="line-395"></a><span class="hs-comment">-- In the event of a runtime exception thrown by any of the children</span><span>
</span><a name="line-396"></a><span class="hs-comment">-- threads, or an asynchronous exception received in the parent</span><span>
</span><a name="line-397"></a><span class="hs-comment">-- thread, all threads will be killed with an 'A.AsyncCancelled'</span><span>
</span><a name="line-398"></a><span class="hs-comment">-- exception and the original exception rethrown. If multiple</span><span>
</span><a name="line-399"></a><span class="hs-comment">-- exceptions are generated by different threads, there are no</span><span>
</span><a name="line-400"></a><span class="hs-comment">-- guarantees on which exception will end up getting rethrown.</span><span>
</span><a name="line-401"></a><span class="hs-comment">--</span><span>
</span><a name="line-402"></a><span class="hs-comment">-- For many common use cases, you may prefer using helper functions in</span><span>
</span><a name="line-403"></a><span class="hs-comment">-- this module like 'mapConcurrently'.</span><span>
</span><a name="line-404"></a><span class="hs-comment">--</span><span>
</span><a name="line-405"></a><span class="hs-comment">-- There are some intentional differences in behavior to</span><span>
</span><a name="line-406"></a><span class="hs-comment">-- @Concurrently@:</span><span>
</span><a name="line-407"></a><span class="hs-comment">--</span><span>
</span><a name="line-408"></a><span class="hs-comment">-- * Children threads are always launched in an unmasked state, not</span><span>
</span><a name="line-409"></a><span class="hs-comment">--   the inherited state of the parent thread.</span><span>
</span><a name="line-410"></a><span class="hs-comment">--</span><span>
</span><a name="line-411"></a><span class="hs-comment">-- Note that it is a programmer error to use the @Alternative@</span><span>
</span><a name="line-412"></a><span class="hs-comment">-- instance in such a way that there are no alternatives to an empty,</span><span>
</span><a name="line-413"></a><span class="hs-comment">-- e.g. @runConc (empty &lt;|&gt; empty)@. In such a case, a 'ConcException'</span><span>
</span><a name="line-414"></a><span class="hs-comment">-- will be thrown. If there was an @Alternative@ in the standard</span><span>
</span><a name="line-415"></a><span class="hs-comment">-- libraries without @empty@, this library would use it instead.</span><span>
</span><a name="line-416"></a><span class="hs-comment">--</span><span>
</span><a name="line-417"></a><span class="hs-comment">-- @since 0.2.9.0</span><span>
</span><a name="line-418"></a><span class="hs-keyword">data</span><span> </span><a name="Conc"><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier">Conc</span></a></a><span> </span><a name="local-6989586621679072238"><a href="#local-6989586621679072238"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679072239"><a href="#local-6989586621679072239"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-419"></a><span>  </span><a name="Action"><a href="UnliftIO.Internals.Async.html#Action"><span class="hs-identifier">Action</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679072240"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072241"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072240"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072241"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-420"></a><span>  </span><a name="Apply"><a href="UnliftIO.Internals.Async.html#Apply"><span class="hs-identifier">Apply</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072242"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072243"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072244"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072242"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072243"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072242"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072244"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-421"></a><span>  </span><a name="LiftA2"><a href="UnliftIO.Internals.Async.html#LiftA2"><span class="hs-identifier">LiftA2</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072245"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072246"><span class="hs-identifier hs-type">y</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072247"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072248"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072245"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072248"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072246"><span class="hs-identifier hs-type">y</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072248"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072247"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-422"></a><span>
</span><a name="line-423"></a><span>  </span><span class="hs-comment">-- Just an optimization to avoid spawning extra threads</span><span>
</span><a name="line-424"></a><span>  </span><a name="Pure"><a href="UnliftIO.Internals.Async.html#Pure"><span class="hs-identifier">Pure</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679072249"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072250"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072249"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-425"></a><span>
</span><a name="line-426"></a><span>  </span><span class="hs-comment">-- I thought there would be an optimization available from having a</span><span>
</span><a name="line-427"></a><span>  </span><span class="hs-comment">-- data constructor that explicit doesn't care about the first</span><span>
</span><a name="line-428"></a><span>  </span><span class="hs-comment">-- result. Turns out it doesn't help much: we still need to keep a</span><span>
</span><a name="line-429"></a><span>  </span><span class="hs-comment">-- TMVar below to know when the thread completes.</span><span>
</span><a name="line-430"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-431"></a><span>  </span><span class="hs-comment">-- Then :: Conc m a -&gt; Conc m b -&gt; Conc m b</span><span>
</span><a name="line-432"></a><span>
</span><a name="line-433"></a><span>  </span><a name="Alt"><a href="UnliftIO.Internals.Async.html#Alt"><span class="hs-identifier">Alt</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072251"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072252"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072251"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072252"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072251"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072252"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-434"></a><span>  </span><a name="Empty"><a href="UnliftIO.Internals.Async.html#Empty"><span class="hs-identifier">Empty</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072253"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072254"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-435"></a><span>
</span><a name="line-436"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="#local-6989586621679073562"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679073562"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-437"></a><span class="hs-comment">-- fmap f (Action routine) = Action (fmap f routine)</span><span>
</span><a name="line-438"></a><span class="hs-comment">-- fmap f (LiftA2 g x y)   = LiftA2 (fmap f g) x y</span><span>
</span><a name="line-439"></a><span class="hs-comment">-- fmap f (Pure val)       = Pure (f val)</span><span>
</span><a name="line-440"></a><span class="hs-comment">-- fmap f (Alt a b)        = Alt (fmap f a) (fmap f b)</span><span>
</span><a name="line-441"></a><span class="hs-comment">-- fmap f Empty            = Empty</span><span>
</span><a name="line-442"></a><span>
</span><a name="line-443"></a><span class="hs-comment">-- | Construct a value of type 'Conc' from an action. Compose these</span><span>
</span><a name="line-444"></a><span class="hs-comment">-- values using the typeclass instances (most commonly 'Applicative'</span><span>
</span><a name="line-445"></a><span class="hs-comment">-- and 'Alternative') and then run with 'runConc'.</span><span>
</span><a name="line-446"></a><span class="hs-comment">--</span><span>
</span><a name="line-447"></a><span class="hs-comment">-- @since 0.2.9.0</span><span>
</span><a name="line-448"></a><span class="hs-identifier">conc</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679072924"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072925"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072924"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072925"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-449"></a><a name="conc"><a href="UnliftIO.Internals.Async.html#conc"><span class="hs-identifier">conc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#Action"><span class="hs-identifier hs-var">Action</span></a><span>
</span><a name="line-450"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">conc</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-451"></a><span>
</span><a name="line-452"></a><span class="hs-comment">-- | Run a 'Conc' value on multiple threads.</span><span>
</span><a name="line-453"></a><span class="hs-comment">--</span><span>
</span><a name="line-454"></a><span class="hs-comment">-- @since 0.2.9.0</span><span>
</span><a name="line-455"></a><span class="hs-identifier">runConc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072922"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072922"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072923"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072922"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072923"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-456"></a><a name="runConc"><a href="UnliftIO.Internals.Async.html#runConc"><span class="hs-identifier">runConc</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#flatten"><span class="hs-identifier hs-var">flatten</span></a><span> </span><span class="hs-operator hs-var">&gt;=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="UnliftIO.Internals.Async.html#runFlat"><span class="hs-identifier hs-var">runFlat</span></a><span class="hs-special">)</span><span>
</span><a name="line-457"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">runConc</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-458"></a><span>
</span><a name="line-459"></a><span class="hs-comment">-- | @since 0.2.9.0</span><span>
</span><a name="line-460"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072272"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072272"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-461"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#Pure"><span class="hs-identifier hs-var">Pure</span></a><span>
</span><a name="line-462"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">pure</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-463"></a><span>  </span><span class="hs-comment">-- | Following is an example of how an 'Applicative' expands to a Tree</span><span>
</span><a name="line-464"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-465"></a><span>  </span><span class="hs-comment">-- @@@</span><span>
</span><a name="line-466"></a><span>  </span><span class="hs-comment">-- downloadA :: IO String</span><span>
</span><a name="line-467"></a><span>  </span><span class="hs-comment">-- downloadB :: IO String</span><span>
</span><a name="line-468"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-469"></a><span>  </span><span class="hs-comment">-- (f &lt;$&gt; conc downloadA &lt;*&gt; conc downloadB &lt;*&gt; pure 123)</span><span>
</span><a name="line-470"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-471"></a><span>  </span><span class="hs-comment">--   (((f &lt;$&gt; a) &lt;*&gt; b) &lt;*&gt; c))</span><span>
</span><a name="line-472"></a><span>  </span><span class="hs-comment">--        (1)    (2)    (3)</span><span>
</span><a name="line-473"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-474"></a><span>  </span><span class="hs-comment">-- (1)</span><span>
</span><a name="line-475"></a><span>  </span><span class="hs-comment">--   Action (fmap f downloadA)</span><span>
</span><a name="line-476"></a><span>  </span><span class="hs-comment">-- (2)</span><span>
</span><a name="line-477"></a><span>  </span><span class="hs-comment">--   Apply (Action (fmap f downloadA)) (Action downloadB)</span><span>
</span><a name="line-478"></a><span>  </span><span class="hs-comment">-- (3)</span><span>
</span><a name="line-479"></a><span>  </span><span class="hs-comment">--   Apply (Apply (Action (fmap f downloadA)) (Action downloadB))</span><span>
</span><a name="line-480"></a><span>  </span><span class="hs-comment">--        (Pure 123)</span><span>
</span><a name="line-481"></a><span>  </span><span class="hs-comment">-- @@@</span><span>
</span><a name="line-482"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-483"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span>
</span><a name="line-484"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&lt;*&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-485"></a><span>  </span><span class="hs-comment">-- See comment above on Then</span><span>
</span><a name="line-486"></a><span>  </span><span class="hs-comment">-- (*&gt;) = Then</span><span>
</span><a name="line-487"></a><span class="hs-cpp">#if MIN_VERSION_base(4,11,0)
</span><span>  </span><a name="local-8214565720323790509"><span class="hs-identifier">liftA2</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#LiftA2"><span class="hs-identifier hs-var">LiftA2</span></a><span>
</span><a name="line-489"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">liftA2</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-490"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-492"></a><span>  </span><a name="local-6989586621679072273"><a href="#local-6989586621679072273"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-3458764513820541681"><span class="hs-operator">*&gt;</span></a><span> </span><a name="local-6989586621679072274"><a href="#local-6989586621679072274"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#LiftA2"><span class="hs-identifier hs-var">LiftA2</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679072275"><a href="#local-6989586621679072275"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072275"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679072273"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679072274"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-493"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">*&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-494"></a><span>
</span><a name="line-495"></a><span class="hs-comment">-- | @since 0.2.9.0</span><span>
</span><a name="line-496"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072271"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Alternative</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072271"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-497"></a><span>  </span><a name="local-8214565720323790513"><span class="hs-identifier">empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-comment">-- this is so ugly, we don't actually want to provide it!</span><span>
</span><a name="line-498"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">empty</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-499"></a><span>  </span><span class="hs-special">(</span><a name="local-8214565720323790512"><span class="hs-operator">&lt;|&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#Alt"><span class="hs-identifier hs-var">Alt</span></a><span>
</span><a name="line-500"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&lt;|&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-501"></a><span>
</span><a name="line-502"></a><span class="hs-cpp">#if MIN_VERSION_base(4, 11, 0)
</span><span class="hs-comment">-- | @since 0.2.9.0</span><span>
</span><a name="line-504"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072269"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="#local-6989586621679072270"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072269"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072270"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-505"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541482"><span class="hs-operator">&lt;&gt;</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftA2</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">&lt;&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-506"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">(</span><span class="hs-pragma">&lt;&gt;</span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-507"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-509"></a><span class="hs-comment">-- | @since 0.2.9.0</span><span>
</span><a name="line-510"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Monoid</span><span> </span><a href="#local-6989586621679072267"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072268"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Monoid</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072268"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072267"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-511"></a><span>  </span><a name="local-3458764513820541483"><span class="hs-identifier">mempty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-identifier hs-var">mempty</span><span>
</span><a name="line-512"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mempty</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-513"></a><span>  </span><a name="local-3458764513820541484"><span class="hs-identifier">mappend</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">liftA2</span><span> </span><span class="hs-identifier hs-var">mappend</span><span>
</span><a name="line-514"></a><span>  </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mappend</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-515"></a><span>
</span><a name="line-516"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-517"></a><span class="hs-comment">-- Conc implementation --</span><span>
</span><a name="line-518"></a><span class="hs-comment">-------------------------</span><span>
</span><a name="line-519"></a><span>
</span><a name="line-520"></a><span class="hs-comment">-- Data types for flattening out the original @Conc@ into a simplified</span><span>
</span><a name="line-521"></a><span class="hs-comment">-- view. Goals:</span><span>
</span><a name="line-522"></a><span class="hs-comment">--</span><span>
</span><a name="line-523"></a><span class="hs-comment">-- * We want to get rid of the Empty data constructor. We don't want</span><span>
</span><a name="line-524"></a><span class="hs-comment">--   it anyway, it's only there because of the Alternative typeclass.</span><span>
</span><a name="line-525"></a><span class="hs-comment">--</span><span>
</span><a name="line-526"></a><span class="hs-comment">-- * We want to ensure that there is no nesting of Alt data</span><span>
</span><a name="line-527"></a><span class="hs-comment">--   constructors. There is a bookkeeping overhead to each time we</span><span>
</span><a name="line-528"></a><span class="hs-comment">--   need to track raced threads, and we want to minimize that</span><span>
</span><a name="line-529"></a><span class="hs-comment">--   bookkeeping.</span><span>
</span><a name="line-530"></a><span class="hs-comment">--</span><span>
</span><a name="line-531"></a><span class="hs-comment">-- * We want to ensure that, when racing, we're always racing at least</span><span>
</span><a name="line-532"></a><span class="hs-comment">--   two threads.</span><span>
</span><a name="line-533"></a><span class="hs-comment">--</span><span>
</span><a name="line-534"></a><span class="hs-comment">-- * We want to simplify down to IO.</span><span>
</span><a name="line-535"></a><span>
</span><a name="line-536"></a><span class="hs-comment">-- | Flattened structure, either Applicative or Alternative</span><span>
</span><a name="line-537"></a><span class="hs-keyword">data</span><span> </span><a name="Flat"><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier">Flat</span></a></a><span> </span><a name="local-6989586621679072237"><a href="#local-6989586621679072237"><span class="hs-identifier">a</span></a></a><span>
</span><a name="line-538"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="FlatApp"><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier">FlatApp</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679072237"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-539"></a><span>  </span><span class="hs-comment">-- | Flattened Alternative. Has at least 2 entries, which must be</span><span>
</span><a name="line-540"></a><span>  </span><span class="hs-comment">-- FlatApp (no nesting of FlatAlts).</span><span>
</span><a name="line-541"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="FlatAlt"><a href="UnliftIO.Internals.Async.html#FlatAlt"><span class="hs-identifier">FlatAlt</span></a></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679072237"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679072237"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679072237"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-542"></a><span>
</span><a name="line-543"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span>
</span><a name="line-544"></a><span class="hs-comment">-- fmap f (FlatApp a) =</span><span>
</span><a name="line-545"></a><span class="hs-comment">--  FlatApp (fmap f a)</span><span>
</span><a name="line-546"></a><span class="hs-comment">-- fmap f (FlatAlt (FlatApp a) (FlatApp b) xs) =</span><span>
</span><a name="line-547"></a><span class="hs-comment">--   FlatAlt (FlatApp (fmap f a)) (FlatApp (fmap f b)) (map (fmap f) xs)</span><span>
</span><a name="line-548"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-549"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">pure</span><span>
</span><a name="line-550"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679072262"><a href="#local-6989586621679072262"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679072263"><a href="#local-6989586621679072263"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatLiftA2"><span class="hs-identifier hs-var">FlatLiftA2</span></a><span> </span><span class="hs-identifier hs-var">id</span><span> </span><a href="#local-6989586621679072262"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679072263"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-551"></a><span class="hs-cpp">#if MIN_VERSION_base(4,11,0)
</span><span>  </span><a name="local-8214565720323790509"><span class="hs-identifier">liftA2</span></a><span> </span><a name="local-6989586621679072264"><a href="#local-6989586621679072264"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679072265"><a href="#local-6989586621679072265"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679072266"><a href="#local-6989586621679072266"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatLiftA2"><span class="hs-identifier hs-var">FlatLiftA2</span></a><span> </span><a href="#local-6989586621679072264"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679072265"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679072266"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-553"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-555"></a><span class="hs-comment">-- | Flattened Applicative. No Alternative stuff directly in here, but may be in</span><span>
</span><a name="line-556"></a><span class="hs-comment">-- the children. Notice this type doesn't have a type parameter for monadic</span><span>
</span><a name="line-557"></a><span class="hs-comment">-- contexts, it hardwires the base monad to IO given concurrency relies</span><span>
</span><a name="line-558"></a><span class="hs-comment">-- eventually on that.</span><span>
</span><a name="line-559"></a><span class="hs-comment">--</span><span>
</span><a name="line-560"></a><span class="hs-comment">-- @since 0.2.9.0</span><span>
</span><a name="line-561"></a><span class="hs-keyword">data</span><span> </span><a name="FlatApp"><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier">FlatApp</span></a></a><span> </span><a name="local-6989586621679072229"><a href="#local-6989586621679072229"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-562"></a><span>  </span><a name="FlatPure"><a href="UnliftIO.Internals.Async.html#FlatPure"><span class="hs-identifier">FlatPure</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679072230"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679072230"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-563"></a><span>  </span><a name="FlatAction"><a href="UnliftIO.Internals.Async.html#FlatAction"><span class="hs-identifier">FlatAction</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679072231"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679072231"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-564"></a><span>  </span><a name="FlatApply"><a href="UnliftIO.Internals.Async.html#FlatApply"><span class="hs-identifier">FlatApply</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072232"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072233"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><a href="#local-6989586621679072232"><span class="hs-identifier hs-type">v</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679072233"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-565"></a><span>  </span><a name="FlatLiftA2"><a href="UnliftIO.Internals.Async.html#FlatLiftA2"><span class="hs-identifier">FlatLiftA2</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072234"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072235"><span class="hs-identifier hs-type">y</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072236"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><a href="#local-6989586621679072234"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><a href="#local-6989586621679072235"><span class="hs-identifier hs-type">y</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679072236"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-566"></a><span>
</span><a name="line-567"></a><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Functor</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span>
</span><a name="line-568"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Applicative</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-569"></a><span>  </span><a name="local-3458764513820541680"><span class="hs-identifier">pure</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatPure"><span class="hs-identifier hs-var">FlatPure</span></a><span>
</span><a name="line-570"></a><span>  </span><span class="hs-special">(</span><a name="local-3458764513820541679"><span class="hs-operator">&lt;*&gt;</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679072257"><a href="#local-6989586621679072257"><span class="hs-identifier">mf</span></a></a><span> </span><a name="local-6989586621679072258"><a href="#local-6989586621679072258"><span class="hs-identifier">ma</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApply"><span class="hs-identifier hs-var">FlatApply</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><a href="#local-6989586621679072257"><span class="hs-identifier hs-var">mf</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><a href="#local-6989586621679072258"><span class="hs-identifier hs-var">ma</span></a><span class="hs-special">)</span><span>
</span><a name="line-571"></a><span class="hs-cpp">#if MIN_VERSION_base(4,11,0)
</span><span>  </span><a name="local-8214565720323790509"><span class="hs-identifier">liftA2</span></a><span> </span><a name="local-6989586621679072259"><a href="#local-6989586621679072259"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679072260"><a href="#local-6989586621679072260"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679072261"><a href="#local-6989586621679072261"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatLiftA2"><span class="hs-identifier hs-var">FlatLiftA2</span></a><span> </span><a href="#local-6989586621679072259"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><a href="#local-6989586621679072260"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><a href="#local-6989586621679072261"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-573"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-575"></a><span class="hs-comment">-- | Things that can go wrong in the structure of a 'Conc'. These are</span><span>
</span><a name="line-576"></a><span class="hs-comment">-- /programmer errors/.</span><span>
</span><a name="line-577"></a><span class="hs-comment">--</span><span>
</span><a name="line-578"></a><span class="hs-comment">-- @since 0.2.9.0</span><span>
</span><a name="line-579"></a><span class="hs-keyword">data</span><span> </span><a name="ConcException"><a href="UnliftIO.Internals.Async.html#ConcException"><span class="hs-identifier">ConcException</span></a></a><span>
</span><a name="line-580"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="EmptyWithNoAlternative"><a href="UnliftIO.Internals.Async.html#EmptyWithNoAlternative"><span class="hs-identifier">EmptyWithNoAlternative</span></a></a><span>
</span><a name="line-581"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">)</span><span>
</span><a name="line-582"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">E.Exception</span><span> </span><a href="UnliftIO.Internals.Async.html#ConcException"><span class="hs-identifier hs-type">ConcException</span></a><span>
</span><a name="line-583"></a><span>
</span><a name="line-584"></a><span class="hs-comment">-- | Simple difference list, for nicer types below</span><span>
</span><a name="line-585"></a><span class="hs-keyword">type</span><span> </span><a name="DList"><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier">DList</span></a></a><span> </span><a name="local-6989586621679072228"><a href="#local-6989586621679072228"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679072228"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679072228"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-586"></a><span>
</span><a name="line-587"></a><span class="hs-identifier">dlistConcat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072921"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072921"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072921"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-588"></a><a name="dlistConcat"><a href="UnliftIO.Internals.Async.html#dlistConcat"><span class="hs-identifier">dlistConcat</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.</span><span class="hs-special">)</span><span>
</span><a name="line-589"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">dlistConcat</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-590"></a><span>
</span><a name="line-591"></a><span class="hs-identifier">dlistCons</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679072920"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072920"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072920"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-592"></a><a name="dlistCons"><a href="UnliftIO.Internals.Async.html#dlistCons"><span class="hs-identifier">dlistCons</span></a></a><span> </span><a name="local-6989586621679073295"><a href="#local-6989586621679073295"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#dlistSingleton"><span class="hs-identifier hs-var">dlistSingleton</span></a><span> </span><a href="#local-6989586621679073295"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="UnliftIO.Internals.Async.html#dlistConcat"><span class="hs-identifier hs-var">dlistConcat</span></a><span class="hs-special">`</span><span> </span><span class="hs-keyword">as</span><span>
</span><a name="line-593"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">dlistCons</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-594"></a><span>
</span><a name="line-595"></a><span class="hs-identifier">dlistConcatAll</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072919"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072919"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-596"></a><a name="dlistConcatAll"><a href="UnliftIO.Internals.Async.html#dlistConcatAll"><span class="hs-identifier">dlistConcatAll</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">.</span><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-597"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">dlistConcatAll</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-598"></a><span>
</span><a name="line-599"></a><span class="hs-identifier">dlistToList</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072918"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679072918"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-600"></a><a name="dlistToList"><a href="UnliftIO.Internals.Async.html#dlistToList"><span class="hs-identifier">dlistToList</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-601"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">dlistToList</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-602"></a><span>
</span><a name="line-603"></a><span class="hs-identifier">dlistSingleton</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679072917"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072917"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-604"></a><a name="dlistSingleton"><a href="UnliftIO.Internals.Async.html#dlistSingleton"><span class="hs-identifier">dlistSingleton</span></a></a><span> </span><a name="local-6989586621679073297"><a href="#local-6989586621679073297"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073297"><span class="hs-identifier hs-var">a</span></a><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><a name="line-605"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">dlistSingleton</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-606"></a><span>
</span><a name="line-607"></a><span class="hs-identifier">dlistEmpty</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><a href="#local-6989586621679072916"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-608"></a><a name="dlistEmpty"><a href="UnliftIO.Internals.Async.html#dlistEmpty"><span class="hs-identifier">dlistEmpty</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-609"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">dlistEmpty</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-610"></a><span>
</span><a name="line-611"></a><span class="hs-comment">-- | Turn a 'Conc' into a 'Flat'. Note that thanks to the ugliness of</span><span>
</span><a name="line-612"></a><span class="hs-comment">-- 'empty', this may fail, e.g. @flatten Empty@.</span><span>
</span><a name="line-613"></a><span class="hs-comment">--</span><span>
</span><a name="line-614"></a><span class="hs-comment">-- @since 0.2.9.0</span><span>
</span><a name="line-615"></a><span class="hs-identifier">flatten</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679072914"><a href="#local-6989586621679072914"><span class="hs-identifier">m</span></a></a><span> </span><a name="local-6989586621679072915"><a href="#local-6989586621679072915"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072914"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072914"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072915"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072914"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><a href="#local-6989586621679072915"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-616"></a><a name="flatten"><a href="UnliftIO.Internals.Async.html#flatten"><span class="hs-identifier">flatten</span></a></a><span> </span><a name="local-6989586621679073298"><a href="#local-6989586621679073298"><span class="hs-identifier">c0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073299"><a href="#local-6989586621679073299"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-617"></a><span>
</span><a name="line-618"></a><span>  </span><span class="hs-comment">-- why not app?</span><span>
</span><a name="line-619"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">both</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679073302"><a href="#local-6989586621679073302"><span class="hs-identifier">k</span></a></a><span class="hs-operator">.</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072914"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073302"><span class="hs-identifier hs-type">k</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><a href="#local-6989586621679073302"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span>
</span><a name="line-620"></a><span>      </span><a name="local-6989586621679073300"><a href="#local-6989586621679073300"><span class="hs-identifier">both</span></a></a><span> </span><a href="UnliftIO.Internals.Async.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">E.throwIO</span><span> </span><a href="UnliftIO.Internals.Async.html#EmptyWithNoAlternative"><span class="hs-identifier hs-var">EmptyWithNoAlternative</span></a><span>
</span><a name="line-621"></a><span>      </span><span class="hs-identifier">both</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Action"><span class="hs-identifier hs-var">Action</span></a><span> </span><a name="local-6989586621679073304"><a href="#local-6989586621679073304"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatAction"><span class="hs-identifier hs-var">FlatAction</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073299"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073304"><span class="hs-identifier hs-var">m</span></a><span>
</span><a name="line-622"></a><span>      </span><span class="hs-identifier">both</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a name="local-6989586621679073305"><a href="#local-6989586621679073305"><span class="hs-identifier">cf</span></a></a><span> </span><a name="local-6989586621679073306"><a href="#local-6989586621679073306"><span class="hs-identifier">ca</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-623"></a><span>        </span><a name="local-6989586621679073307"><a href="#local-6989586621679073307"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073305"><span class="hs-identifier hs-var">cf</span></a><span>
</span><a name="line-624"></a><span>        </span><a name="local-6989586621679073308"><a href="#local-6989586621679073308"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073306"><span class="hs-identifier hs-var">ca</span></a><span>
</span><a name="line-625"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApply"><span class="hs-identifier hs-var">FlatApply</span></a><span> </span><a href="#local-6989586621679073307"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073308"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-626"></a><span>      </span><span class="hs-identifier">both</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#LiftA2"><span class="hs-identifier hs-var">LiftA2</span></a><span> </span><a name="local-6989586621679073309"><a href="#local-6989586621679073309"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073310"><a href="#local-6989586621679073310"><span class="hs-identifier">ca</span></a></a><span> </span><a name="local-6989586621679073311"><a href="#local-6989586621679073311"><span class="hs-identifier">cb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-627"></a><span>        </span><a name="local-6989586621679073312"><a href="#local-6989586621679073312"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073310"><span class="hs-identifier hs-var">ca</span></a><span>
</span><a name="line-628"></a><span>        </span><a name="local-6989586621679073313"><a href="#local-6989586621679073313"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073311"><span class="hs-identifier hs-var">cb</span></a><span>
</span><a name="line-629"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatLiftA2"><span class="hs-identifier hs-var">FlatLiftA2</span></a><span> </span><a href="#local-6989586621679073309"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073312"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073313"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-630"></a><span>      </span><span class="hs-identifier">both</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Alt"><span class="hs-identifier hs-var">Alt</span></a><span> </span><a name="local-6989586621679073314"><a href="#local-6989586621679073314"><span class="hs-identifier">ca</span></a></a><span> </span><a name="local-6989586621679073315"><a href="#local-6989586621679073315"><span class="hs-identifier">cb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-631"></a><span>        </span><a name="local-6989586621679073316"><a href="#local-6989586621679073316"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073301"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621679073314"><span class="hs-identifier hs-var">ca</span></a><span>
</span><a name="line-632"></a><span>        </span><a name="local-6989586621679073317"><a href="#local-6989586621679073317"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073301"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621679073315"><span class="hs-identifier hs-var">cb</span></a><span>
</span><a name="line-633"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="UnliftIO.Internals.Async.html#dlistToList"><span class="hs-identifier hs-var">dlistToList</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073316"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="UnliftIO.Internals.Async.html#dlistConcat"><span class="hs-identifier hs-var">dlistConcat</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679073317"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-634"></a><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">E.throwIO</span><span> </span><a href="UnliftIO.Internals.Async.html#EmptyWithNoAlternative"><span class="hs-identifier hs-var">EmptyWithNoAlternative</span></a><span>
</span><a name="line-635"></a><span>          </span><span class="hs-special">[</span><a name="local-6989586621679073318"><a href="#local-6989586621679073318"><span class="hs-identifier">x</span></a></a><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><a href="#local-6989586621679073318"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-636"></a><span>          </span><a name="local-6989586621679073319"><a href="#local-6989586621679073319"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679073320"><a href="#local-6989586621679073320"><span class="hs-identifier">y</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621679073321"><a href="#local-6989586621679073321"><span class="hs-identifier">z</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatAlt"><span class="hs-identifier hs-var">FlatAlt</span></a><span> </span><a href="#local-6989586621679073319"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679073320"><span class="hs-identifier hs-var">y</span></a><span> </span><a href="#local-6989586621679073321"><span class="hs-identifier hs-var">z</span></a><span>
</span><a name="line-637"></a><span>      </span><span class="hs-identifier">both</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Pure"><span class="hs-identifier hs-var">Pure</span></a><span> </span><a name="local-6989586621679073322"><a href="#local-6989586621679073322"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatPure"><span class="hs-identifier hs-var">FlatPure</span></a><span> </span><a href="#local-6989586621679073322"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-638"></a><span>
</span><a name="line-639"></a><span>      </span><span class="hs-comment">-- Returns a difference list for cheaper concatenation</span><span>
</span><a name="line-640"></a><span>      </span><span class="hs-identifier">alt</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679073303"><a href="#local-6989586621679073303"><span class="hs-identifier">k</span></a></a><span class="hs-operator">.</span><span> </span><a href="UnliftIO.Internals.Async.html#Conc"><span class="hs-identifier hs-type">Conc</span></a><span> </span><a href="#local-6989586621679072914"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679073303"><span class="hs-identifier hs-type">k</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-type">FlatApp</span></a><span> </span><a href="#local-6989586621679073303"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-641"></a><span>      </span><a name="local-6989586621679073301"><a href="#local-6989586621679073301"><span class="hs-identifier">alt</span></a></a><span> </span><a href="UnliftIO.Internals.Async.html#Empty"><span class="hs-identifier hs-var">Empty</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="UnliftIO.Internals.Async.html#dlistEmpty"><span class="hs-identifier hs-var">dlistEmpty</span></a><span>
</span><a name="line-642"></a><span>      </span><span class="hs-identifier">alt</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Apply"><span class="hs-identifier hs-var">Apply</span></a><span> </span><a name="local-6989586621679073323"><a href="#local-6989586621679073323"><span class="hs-identifier">cf</span></a></a><span> </span><a name="local-6989586621679073324"><a href="#local-6989586621679073324"><span class="hs-identifier">ca</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-643"></a><span>        </span><a name="local-6989586621679073325"><a href="#local-6989586621679073325"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073323"><span class="hs-identifier hs-var">cf</span></a><span>
</span><a name="line-644"></a><span>        </span><a name="local-6989586621679073326"><a href="#local-6989586621679073326"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073324"><span class="hs-identifier hs-var">ca</span></a><span>
</span><a name="line-645"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#dlistSingleton"><span class="hs-identifier hs-var">dlistSingleton</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApply"><span class="hs-identifier hs-var">FlatApply</span></a><span> </span><a href="#local-6989586621679073325"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073326"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-646"></a><span>      </span><span class="hs-identifier">alt</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Alt"><span class="hs-identifier hs-var">Alt</span></a><span> </span><a name="local-6989586621679073327"><a href="#local-6989586621679073327"><span class="hs-identifier">ca</span></a></a><span> </span><a name="local-6989586621679073328"><a href="#local-6989586621679073328"><span class="hs-identifier">cb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-647"></a><span>        </span><a name="local-6989586621679073329"><a href="#local-6989586621679073329"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073301"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621679073327"><span class="hs-identifier hs-var">ca</span></a><span>
</span><a name="line-648"></a><span>        </span><a name="local-6989586621679073330"><a href="#local-6989586621679073330"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073301"><span class="hs-identifier hs-var">alt</span></a><span> </span><a href="#local-6989586621679073328"><span class="hs-identifier hs-var">cb</span></a><span>
</span><a name="line-649"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073329"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-special">`</span><a href="UnliftIO.Internals.Async.html#dlistConcat"><span class="hs-identifier hs-var">dlistConcat</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679073330"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-650"></a><span>      </span><span class="hs-identifier">alt</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Action"><span class="hs-identifier hs-var">Action</span></a><span> </span><a name="local-6989586621679073331"><a href="#local-6989586621679073331"><span class="hs-identifier">m</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#dlistSingleton"><span class="hs-identifier hs-var">dlistSingleton</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatAction"><span class="hs-identifier hs-var">FlatAction</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073299"><span class="hs-identifier hs-var">run</span></a><span> </span><a href="#local-6989586621679073331"><span class="hs-identifier hs-var">m</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-651"></a><span>      </span><span class="hs-identifier">alt</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#LiftA2"><span class="hs-identifier hs-var">LiftA2</span></a><span> </span><a name="local-6989586621679073332"><a href="#local-6989586621679073332"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073333"><a href="#local-6989586621679073333"><span class="hs-identifier">ca</span></a></a><span> </span><a name="local-6989586621679073334"><a href="#local-6989586621679073334"><span class="hs-identifier">cb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-652"></a><span>        </span><a name="local-6989586621679073335"><a href="#local-6989586621679073335"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073333"><span class="hs-identifier hs-var">ca</span></a><span>
</span><a name="line-653"></a><span>        </span><a name="local-6989586621679073336"><a href="#local-6989586621679073336"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073334"><span class="hs-identifier hs-var">cb</span></a><span>
</span><a name="line-654"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#dlistSingleton"><span class="hs-identifier hs-var">dlistSingleton</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatLiftA2"><span class="hs-identifier hs-var">FlatLiftA2</span></a><span> </span><a href="#local-6989586621679073332"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073335"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="#local-6989586621679073336"><span class="hs-identifier hs-var">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-655"></a><span>      </span><span class="hs-identifier">alt</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#Pure"><span class="hs-identifier hs-var">Pure</span></a><span> </span><a name="local-6989586621679073337"><a href="#local-6989586621679073337"><span class="hs-identifier">a</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#dlistSingleton"><span class="hs-identifier hs-var">dlistSingleton</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatPure"><span class="hs-identifier hs-var">FlatPure</span></a><span> </span><a href="#local-6989586621679073337"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">)</span><span>
</span><a name="line-656"></a><span>
</span><a name="line-657"></a><span>  </span><a href="#local-6989586621679073300"><span class="hs-identifier hs-var">both</span></a><span> </span><a href="#local-6989586621679073298"><span class="hs-identifier hs-var">c0</span></a><span>
</span><a name="line-658"></a><span>
</span><a name="line-659"></a><span class="hs-comment">-- | Run a @Flat a@ on multiple threads.</span><span>
</span><a name="line-660"></a><span class="hs-identifier">runFlat</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><a href="#local-6989586621679072913"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679072913"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-661"></a><span>
</span><a name="line-662"></a><span class="hs-comment">-- Silly, simple optimizations</span><span>
</span><a name="line-663"></a><a name="runFlat"><a href="UnliftIO.Internals.Async.html#runFlat"><span class="hs-identifier">runFlat</span></a></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatAction"><span class="hs-identifier hs-var">FlatAction</span></a><span> </span><a name="local-6989586621679073338"><a href="#local-6989586621679073338"><span class="hs-identifier">io</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679073338"><span class="hs-identifier hs-var">io</span></a><span>
</span><a name="line-664"></a><span class="hs-identifier">runFlat</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatPure"><span class="hs-identifier hs-var">FlatPure</span></a><span> </span><a name="local-6989586621679073339"><a href="#local-6989586621679073339"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679073339"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-665"></a><span>
</span><a name="line-666"></a><span class="hs-comment">-- Start off with all exceptions masked so we can install proper cleanup.</span><span>
</span><a name="line-667"></a><span class="hs-identifier">runFlat</span><span> </span><a name="local-6989586621679073340"><a href="#local-6989586621679073340"><span class="hs-identifier">f0</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">E.uninterruptibleMask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073341"><a href="#local-6989586621679073341"><span class="hs-identifier">restore</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-668"></a><span>  </span><span class="hs-comment">-- How many threads have been spawned and finished their task? We need to</span><span>
</span><a name="line-669"></a><span>  </span><span class="hs-comment">-- ensure we kill all child threads and wait for them to die.</span><span>
</span><a name="line-670"></a><span>  </span><a name="local-6989586621679073342"><a href="#local-6989586621679073342"><span class="hs-identifier">resultCountVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newTVarIO</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-671"></a><span>
</span><a name="line-672"></a><span>  </span><span class="hs-comment">-- Forks off as many threads as necessary to run the given Flat a,</span><span>
</span><a name="line-673"></a><span>  </span><span class="hs-comment">-- and returns:</span><span>
</span><a name="line-674"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-675"></a><span>  </span><span class="hs-comment">-- + An STM action that will block until completion and return the</span><span>
</span><a name="line-676"></a><span>  </span><span class="hs-comment">--   result.</span><span>
</span><a name="line-677"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-678"></a><span>  </span><span class="hs-comment">-- + The IDs of all forked threads. These need to be tracked so they</span><span>
</span><a name="line-679"></a><span>  </span><span class="hs-comment">--   can be killed (either when an exception is thrown, or when one</span><span>
</span><a name="line-680"></a><span>  </span><span class="hs-comment">--   of the alternatives completes first).</span><span>
</span><a name="line-681"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-682"></a><span>  </span><span class="hs-comment">-- It would be nice to have the returned STM action return an Either</span><span>
</span><a name="line-683"></a><span>  </span><span class="hs-comment">-- and keep the SomeException values somewhat explicit, but in all</span><span>
</span><a name="line-684"></a><span>  </span><span class="hs-comment">-- my testing this absolutely kills performance. Instead, we're</span><span>
</span><a name="line-685"></a><span>  </span><span class="hs-comment">-- going to use a hack of providing a TMVar to fill up with a</span><span>
</span><a name="line-686"></a><span>  </span><span class="hs-comment">-- SomeException when things fail.</span><span>
</span><a name="line-687"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-688"></a><span>  </span><span class="hs-comment">-- TODO: Investigate why performance degradation on Either</span><span>
</span><a name="line-689"></a><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">go</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679073344"><a href="#local-6989586621679073344"><span class="hs-identifier">a</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-690"></a><span>            </span><span class="hs-identifier hs-type">TMVar</span><span> </span><span class="hs-identifier hs-type">E.SomeException</span><span>
</span><a name="line-691"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#Flat"><span class="hs-identifier hs-type">Flat</span></a><span> </span><a href="#local-6989586621679073344"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-692"></a><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">STM</span><span> </span><a href="#local-6989586621679073344"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><a href="UnliftIO.Internals.Async.html#DList"><span class="hs-identifier hs-type">DList</span></a><span> </span><span class="hs-identifier hs-type">C.ThreadId</span><span class="hs-special">)</span><span>
</span><a name="line-693"></a><span>      </span><a name="local-6989586621679073343"><a href="#local-6989586621679073343"><span class="hs-identifier">go</span></a></a><span> </span><a name="local-6989586621679073410"><a href="#local-6989586621679073410"><span class="hs-identifier">_excVar</span></a></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatPure"><span class="hs-identifier hs-var">FlatPure</span></a><span> </span><a name="local-6989586621679073411"><a href="#local-6989586621679073411"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679073411"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="UnliftIO.Internals.Async.html#dlistEmpty"><span class="hs-identifier hs-var">dlistEmpty</span></a><span class="hs-special">)</span><span>
</span><a name="line-694"></a><span>      </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679073412"><a href="#local-6989586621679073412"><span class="hs-identifier">excVar</span></a></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatAction"><span class="hs-identifier hs-var">FlatAction</span></a><span> </span><a name="local-6989586621679073413"><a href="#local-6989586621679073413"><span class="hs-identifier">io</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-695"></a><span>        </span><a name="local-6989586621679073414"><a href="#local-6989586621679073414"><span class="hs-identifier">resVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyTMVarIO</span><span>
</span><a name="line-696"></a><span>        </span><a name="local-6989586621679073436"><a href="#local-6989586621679073436"><span class="hs-identifier">tid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">C.forkIOWithUnmask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073415"><a href="#local-6989586621679073415"><span class="hs-identifier">restore1</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-697"></a><span>          </span><a name="local-6989586621679073416"><a href="#local-6989586621679073416"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">E.try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073415"><span class="hs-identifier hs-var">restore1</span></a><span> </span><a href="#local-6989586621679073413"><span class="hs-identifier hs-var">io</span></a><span>
</span><a name="line-698"></a><span>          </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-699"></a><span>            </span><span class="hs-identifier hs-var">modifyTVar'</span><span> </span><a href="#local-6989586621679073342"><span class="hs-identifier hs-var">resultCountVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-700"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679073416"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-701"></a><span>              </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679073434"><a href="#local-6989586621679073434"><span class="hs-identifier">e</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tryPutTMVar</span><span> </span><a href="#local-6989586621679073412"><span class="hs-identifier hs-var">excVar</span></a><span> </span><a href="#local-6989586621679073434"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-702"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679073435"><a href="#local-6989586621679073435"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putTMVar</span><span> </span><a href="#local-6989586621679073414"><span class="hs-identifier hs-var">resVar</span></a><span> </span><a href="#local-6989586621679073435"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-703"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">readTMVar</span><span> </span><a href="#local-6989586621679073414"><span class="hs-identifier hs-var">resVar</span></a><span class="hs-special">,</span><span> </span><a href="UnliftIO.Internals.Async.html#dlistSingleton"><span class="hs-identifier hs-var">dlistSingleton</span></a><span> </span><a href="#local-6989586621679073436"><span class="hs-identifier hs-var">tid</span></a><span class="hs-special">)</span><span>
</span><a name="line-704"></a><span>      </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679073437"><a href="#local-6989586621679073437"><span class="hs-identifier">excVar</span></a></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApply"><span class="hs-identifier hs-var">FlatApply</span></a><span> </span><a name="local-6989586621679073438"><a href="#local-6989586621679073438"><span class="hs-identifier">cf</span></a></a><span> </span><a name="local-6989586621679073439"><a href="#local-6989586621679073439"><span class="hs-identifier">ca</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-705"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679073440"><a href="#local-6989586621679073440"><span class="hs-identifier">f</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679073441"><a href="#local-6989586621679073441"><span class="hs-identifier">tidsf</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073437"><span class="hs-identifier hs-var">excVar</span></a><span> </span><a href="#local-6989586621679073438"><span class="hs-identifier hs-var">cf</span></a><span>
</span><a name="line-706"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679073442"><a href="#local-6989586621679073442"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679073443"><a href="#local-6989586621679073443"><span class="hs-identifier">tidsa</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073437"><span class="hs-identifier hs-var">excVar</span></a><span> </span><a href="#local-6989586621679073439"><span class="hs-identifier hs-var">ca</span></a><span>
</span><a name="line-707"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073440"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-operator hs-var">&lt;*&gt;</span><span> </span><a href="#local-6989586621679073442"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679073441"><span class="hs-identifier hs-var">tidsf</span></a><span> </span><span class="hs-special">`</span><a href="UnliftIO.Internals.Async.html#dlistConcat"><span class="hs-identifier hs-var">dlistConcat</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679073443"><span class="hs-identifier hs-var">tidsa</span></a><span class="hs-special">)</span><span>
</span><a name="line-708"></a><span>      </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679073444"><a href="#local-6989586621679073444"><span class="hs-identifier">excVar</span></a></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatLiftA2"><span class="hs-identifier hs-var">FlatLiftA2</span></a><span> </span><a name="local-6989586621679073445"><a href="#local-6989586621679073445"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073446"><a href="#local-6989586621679073446"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621679073447"><a href="#local-6989586621679073447"><span class="hs-identifier">b</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-709"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679073448"><a href="#local-6989586621679073448"><span class="hs-identifier">a'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679073449"><a href="#local-6989586621679073449"><span class="hs-identifier">tidsa</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073444"><span class="hs-identifier hs-var">excVar</span></a><span> </span><a href="#local-6989586621679073446"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-710"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621679073450"><a href="#local-6989586621679073450"><span class="hs-identifier">b'</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679073451"><a href="#local-6989586621679073451"><span class="hs-identifier">tidsb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073444"><span class="hs-identifier hs-var">excVar</span></a><span> </span><a href="#local-6989586621679073447"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-711"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftA2</span><span> </span><a href="#local-6989586621679073445"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073448"><span class="hs-identifier hs-var">a'</span></a><span> </span><a href="#local-6989586621679073450"><span class="hs-identifier hs-var">b'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679073449"><span class="hs-identifier hs-var">tidsa</span></a><span> </span><span class="hs-special">`</span><a href="UnliftIO.Internals.Async.html#dlistConcat"><span class="hs-identifier hs-var">dlistConcat</span></a><span class="hs-special">`</span><span> </span><a href="#local-6989586621679073451"><span class="hs-identifier hs-var">tidsb</span></a><span class="hs-special">)</span><span>
</span><a name="line-712"></a><span>
</span><a name="line-713"></a><span>      </span><span class="hs-identifier">go</span><span> </span><a name="local-6989586621679073452"><a href="#local-6989586621679073452"><span class="hs-identifier">excVar0</span></a></a><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#FlatAlt"><span class="hs-identifier hs-var">FlatAlt</span></a><span> </span><a name="local-6989586621679073453"><a href="#local-6989586621679073453"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679073454"><a href="#local-6989586621679073454"><span class="hs-identifier">y</span></a></a><span> </span><a name="local-6989586621679073455"><a href="#local-6989586621679073455"><span class="hs-identifier">z</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-714"></a><span>        </span><span class="hs-comment">-- As soon as one of the children finishes, we need to kill the siblings,</span><span>
</span><a name="line-715"></a><span>        </span><span class="hs-comment">-- we're going to create our own excVar here to pass to the children, so</span><span>
</span><a name="line-716"></a><span>        </span><span class="hs-comment">-- we can prevent the ThreadKilled exceptions we throw to the children</span><span>
</span><a name="line-717"></a><span>        </span><span class="hs-comment">-- here from propagating and taking down the whole system.</span><span>
</span><a name="line-718"></a><span>        </span><a name="local-6989586621679073456"><a href="#local-6989586621679073456"><span class="hs-identifier">excVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyTMVarIO</span><span>
</span><a name="line-719"></a><span>        </span><a name="local-6989586621679073457"><a href="#local-6989586621679073457"><span class="hs-identifier">resVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyTMVarIO</span><span>
</span><a name="line-720"></a><span>        </span><a name="local-6989586621679073458"><a href="#local-6989586621679073458"><span class="hs-identifier">pairs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">traverse</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073456"><span class="hs-identifier hs-var">excVar</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="UnliftIO.Internals.Async.html#FlatApp"><span class="hs-identifier hs-var">FlatApp</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073453"><span class="hs-identifier hs-var">x</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679073454"><span class="hs-identifier hs-var">y</span></a><span class="hs-glyph">:</span><a href="#local-6989586621679073455"><span class="hs-identifier hs-var">z</span></a><span class="hs-special">)</span><span>
</span><a name="line-721"></a><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679073459"><a href="#local-6989586621679073459"><span class="hs-identifier">blockers</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679073460"><a href="#local-6989586621679073460"><span class="hs-identifier">workerTids</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">unzip</span><span> </span><a href="#local-6989586621679073458"><span class="hs-identifier hs-var">pairs</span></a><span>
</span><a name="line-722"></a><span>
</span><a name="line-723"></a><span>        </span><span class="hs-comment">-- Fork a helper thread to wait for the first child to</span><span>
</span><a name="line-724"></a><span>        </span><span class="hs-comment">-- complete, or for one of them to die with an exception so we</span><span>
</span><a name="line-725"></a><span>        </span><span class="hs-comment">-- can propagate it to excVar0.</span><span>
</span><a name="line-726"></a><span>        </span><a name="local-6989586621679073469"><a href="#local-6989586621679073469"><span class="hs-identifier">helperTid</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">C.forkIOWithUnmask</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073461"><a href="#local-6989586621679073461"><span class="hs-identifier">restore1</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-727"></a><span>          </span><a name="local-6989586621679073464"><a href="#local-6989586621679073464"><span class="hs-identifier">eres</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">E.try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073461"><span class="hs-identifier hs-var">restore1</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldr</span><span>
</span><a name="line-728"></a><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679073462"><a href="#local-6989586621679073462"><span class="hs-identifier">blocker</span></a></a><span> </span><a name="local-6989586621679073463"><a href="#local-6989586621679073463"><span class="hs-identifier">rest</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679073462"><span class="hs-identifier hs-var">blocker</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span> </span><a href="#local-6989586621679073463"><span class="hs-identifier hs-var">rest</span></a><span class="hs-special">)</span><span>
</span><a name="line-729"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">readTMVar</span><span> </span><a href="#local-6989586621679073456"><span class="hs-identifier hs-var">excVar</span></a><span class="hs-special">)</span><span>
</span><a name="line-730"></a><span>            </span><a href="#local-6989586621679073459"><span class="hs-identifier hs-var">blockers</span></a><span>
</span><a name="line-731"></a><span>          </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-732"></a><span>            </span><span class="hs-identifier hs-var">modifyTVar'</span><span> </span><a href="#local-6989586621679073342"><span class="hs-identifier hs-var">resultCountVar</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-733"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679073464"><span class="hs-identifier hs-var">eres</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-734"></a><span>              </span><span class="hs-comment">-- NOTE: The child threads are spawned from @traverse go@ call above, they</span><span>
</span><a name="line-735"></a><span>              </span><span class="hs-comment">-- are _not_ children of this helper thread, and helper thread doesn't throw</span><span>
</span><a name="line-736"></a><span>              </span><span class="hs-comment">-- synchronous exceptions, so, any exception that the try above would catch</span><span>
</span><a name="line-737"></a><span>              </span><span class="hs-comment">-- must be an async exception.</span><span>
</span><a name="line-738"></a><span>              </span><span class="hs-comment">-- We were killed by an async exception, do nothing.</span><span>
</span><a name="line-739"></a><span>              </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">E.SomeException</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-740"></a><span>              </span><span class="hs-comment">-- Child thread died, propagate it</span><span>
</span><a name="line-741"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679073465"><a href="#local-6989586621679073465"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">void</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">tryPutTMVar</span><span> </span><a href="#local-6989586621679073452"><span class="hs-identifier hs-var">excVar0</span></a><span> </span><a href="#local-6989586621679073465"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-742"></a><span>              </span><span class="hs-comment">-- Successful result from one of the children</span><span>
</span><a name="line-743"></a><span>              </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679073466"><a href="#local-6989586621679073466"><span class="hs-identifier">res</span></a></a><span class="hs-special">)</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">putTMVar</span><span> </span><a href="#local-6989586621679073457"><span class="hs-identifier hs-var">resVar</span></a><span> </span><a href="#local-6989586621679073466"><span class="hs-identifier hs-var">res</span></a><span>
</span><a name="line-744"></a><span>
</span><a name="line-745"></a><span>          </span><span class="hs-comment">-- And kill all of the threads</span><span>
</span><a name="line-746"></a><span>          </span><span class="hs-identifier hs-var">for_</span><span> </span><a href="#local-6989586621679073460"><span class="hs-identifier hs-var">workerTids</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073467"><a href="#local-6989586621679073467"><span class="hs-identifier">tids'</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-747"></a><span>            </span><span class="hs-comment">-- NOTE: Replacing A.AsyncCancelled with KillThread as the</span><span>
</span><a name="line-748"></a><span>            </span><span class="hs-comment">-- 'A.AsyncCancelled' constructor is not exported in older versions</span><span>
</span><a name="line-749"></a><span>            </span><span class="hs-comment">-- of the async package</span><span>
</span><a name="line-750"></a><span>            </span><span class="hs-comment">-- for_ (tids' []) $ \workerTid -&gt; E.throwTo workerTid A.AsyncCancelled</span><span>
</span><a name="line-751"></a><span>            </span><span class="hs-identifier hs-var">for_</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#dlistToList"><span class="hs-identifier hs-var">dlistToList</span></a><span> </span><a href="#local-6989586621679073467"><span class="hs-identifier hs-var">tids'</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073468"><a href="#local-6989586621679073468"><span class="hs-identifier">workerTid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">C.killThread</span><span> </span><a href="#local-6989586621679073468"><span class="hs-identifier hs-var">workerTid</span></a><span>
</span><a name="line-752"></a><span>
</span><a name="line-753"></a><span>        </span><span class="hs-identifier hs-var">pure</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">readTMVar</span><span> </span><a href="#local-6989586621679073457"><span class="hs-identifier hs-var">resVar</span></a><span>
</span><a name="line-754"></a><span>             </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679073469"><span class="hs-identifier hs-var">helperTid</span></a><span> </span><span class="hs-special">`</span><a href="UnliftIO.Internals.Async.html#dlistCons"><span class="hs-identifier hs-var">dlistCons</span></a><span class="hs-special">`</span><span> </span><a href="UnliftIO.Internals.Async.html#dlistConcatAll"><span class="hs-identifier hs-var">dlistConcatAll</span></a><span> </span><a href="#local-6989586621679073460"><span class="hs-identifier hs-var">workerTids</span></a><span>
</span><a name="line-755"></a><span>             </span><span class="hs-special">)</span><span>
</span><a name="line-756"></a><span>
</span><a name="line-757"></a><span>  </span><a name="local-6989586621679073470"><a href="#local-6989586621679073470"><span class="hs-identifier">excVar</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newEmptyTMVarIO</span><span>
</span><a name="line-758"></a><span>  </span><span class="hs-special">(</span><a name="local-6989586621679073471"><a href="#local-6989586621679073471"><span class="hs-identifier">getRes</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679073472"><a href="#local-6989586621679073472"><span class="hs-identifier">tids0</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679073343"><span class="hs-identifier hs-var">go</span></a><span> </span><a href="#local-6989586621679073470"><span class="hs-identifier hs-var">excVar</span></a><span> </span><a href="#local-6989586621679073340"><span class="hs-identifier hs-var">f0</span></a><span>
</span><a name="line-759"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073473"><a href="#local-6989586621679073473"><span class="hs-identifier">tids</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="UnliftIO.Internals.Async.html#dlistToList"><span class="hs-identifier hs-var">dlistToList</span></a><span> </span><a href="#local-6989586621679073472"><span class="hs-identifier hs-var">tids0</span></a><span>
</span><a name="line-760"></a><span>      </span><a name="local-6989586621679073474"><a href="#local-6989586621679073474"><span class="hs-identifier">tidCount</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><a href="#local-6989586621679073473"><span class="hs-identifier hs-var">tids</span></a><span>
</span><a name="line-761"></a><span>      </span><a name="local-6989586621679073475"><a href="#local-6989586621679073475"><span class="hs-identifier">allDone</span></a></a><span> </span><a name="local-6989586621679073476"><a href="#local-6989586621679073476"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-762"></a><span>        </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679073476"><span class="hs-identifier hs-var">count</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><a href="#local-6989586621679073474"><span class="hs-identifier hs-var">tidCount</span></a><span>
</span><a name="line-763"></a><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;allDone: count (&quot;</span><span>
</span><a name="line-764"></a><span>                      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679073476"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-765"></a><span>                      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;) should never be greater than tidCount (&quot;</span><span>
</span><a name="line-766"></a><span>                      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679073474"><span class="hs-identifier hs-var">tidCount</span></a><span>
</span><a name="line-767"></a><span>                      </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;)&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-768"></a><span>          </span><span class="hs-keyword">else</span><span> </span><a href="#local-6989586621679073476"><span class="hs-identifier hs-var">count</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679073474"><span class="hs-identifier hs-var">tidCount</span></a><span>
</span><a name="line-769"></a><span>
</span><a name="line-770"></a><span>  </span><span class="hs-comment">-- Automatically retry if we get killed by a</span><span>
</span><a name="line-771"></a><span>  </span><span class="hs-comment">-- BlockedIndefinitelyOnSTM. For more information, see:</span><span>
</span><a name="line-772"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-773"></a><span>  </span><span class="hs-comment">-- + https:\/\/github.com\/simonmar\/async\/issues\/14</span><span>
</span><a name="line-774"></a><span>  </span><span class="hs-comment">-- + https:\/\/github.com\/simonmar\/async\/pull\/15</span><span>
</span><a name="line-775"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-776"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073491"><a href="#local-6989586621679073491"><span class="hs-identifier">autoRetry</span></a></a><span> </span><a name="local-6989586621679073492"><a href="#local-6989586621679073492"><span class="hs-identifier">action</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-777"></a><span>        </span><a href="#local-6989586621679073492"><span class="hs-identifier hs-var">action</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">E.catch</span><span class="hs-special">`</span><span>
</span><a name="line-778"></a><span>        </span><span class="hs-glyph">\</span><span class="hs-identifier hs-var">E.BlockedIndefinitelyOnSTM</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073491"><span class="hs-identifier hs-var">autoRetry</span></a><span> </span><a href="#local-6989586621679073492"><span class="hs-identifier hs-var">action</span></a><span>
</span><a name="line-779"></a><span>
</span><a name="line-780"></a><span>  </span><span class="hs-comment">-- Restore the original masking state while blocking and catch</span><span>
</span><a name="line-781"></a><span>  </span><span class="hs-comment">-- exceptions to allow the parent thread to be killed early.</span><span>
</span><a name="line-782"></a><span>  </span><a name="local-6989586621679073493"><a href="#local-6989586621679073493"><span class="hs-identifier">res</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">E.try</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073341"><span class="hs-identifier hs-var">restore</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073491"><span class="hs-identifier hs-var">autoRetry</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-783"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">readTMVar</span><span> </span><a href="#local-6989586621679073470"><span class="hs-identifier hs-var">excVar</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;|&gt;</span><span>
</span><a name="line-784"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="#local-6989586621679073471"><span class="hs-identifier hs-var">getRes</span></a><span class="hs-special">)</span><span>
</span><a name="line-785"></a><span>
</span><a name="line-786"></a><span>  </span><a name="local-6989586621679073494"><a href="#local-6989586621679073494"><span class="hs-identifier">count0</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readTVar</span><span> </span><a href="#local-6989586621679073342"><span class="hs-identifier hs-var">resultCountVar</span></a><span>
</span><a name="line-787"></a><span>  </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073475"><span class="hs-identifier hs-var">allDone</span></a><span> </span><a href="#local-6989586621679073494"><span class="hs-identifier hs-var">count0</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-788"></a><span>    </span><span class="hs-comment">-- Kill all of the threads</span><span>
</span><a name="line-789"></a><span>    </span><span class="hs-comment">-- NOTE: Replacing A.AsyncCancelled with KillThread as the</span><span>
</span><a name="line-790"></a><span>    </span><span class="hs-comment">-- 'A.AsyncCancelled' constructor is not exported in older versions</span><span>
</span><a name="line-791"></a><span>    </span><span class="hs-comment">-- of the async package</span><span>
</span><a name="line-792"></a><span>    </span><span class="hs-comment">-- for_ tids $ \tid -&gt; E.throwTo tid A.AsyncCancelled</span><span>
</span><a name="line-793"></a><span>    </span><span class="hs-identifier hs-var">for_</span><span> </span><a href="#local-6989586621679073473"><span class="hs-identifier hs-var">tids</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073495"><a href="#local-6989586621679073495"><span class="hs-identifier">tid</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">C.killThread</span><span> </span><a href="#local-6989586621679073495"><span class="hs-identifier hs-var">tid</span></a><span>
</span><a name="line-794"></a><span>
</span><a name="line-795"></a><span>    </span><span class="hs-comment">-- Wait for all of the threads to die. We're going to restore the original</span><span>
</span><a name="line-796"></a><span>    </span><span class="hs-comment">-- masking state here, just in case there's a bug in the cleanup code of a</span><span>
</span><a name="line-797"></a><span>    </span><span class="hs-comment">-- child thread, so that we can be killed by an async exception. We decided</span><span>
</span><a name="line-798"></a><span>    </span><span class="hs-comment">-- this is a better behavior than hanging indefinitely and wait for a SIGKILL.</span><span>
</span><a name="line-799"></a><span>    </span><a href="#local-6989586621679073341"><span class="hs-identifier hs-var">restore</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-800"></a><span>      </span><a name="local-6989586621679073496"><a href="#local-6989586621679073496"><span class="hs-identifier">count</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">readTVar</span><span> </span><a href="#local-6989586621679073342"><span class="hs-identifier hs-var">resultCountVar</span></a><span>
</span><a name="line-801"></a><span>      </span><span class="hs-comment">-- retries until resultCountVar has increased to the threadId count returned by go</span><span>
</span><a name="line-802"></a><span>      </span><span class="hs-identifier hs-var">check</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-6989586621679073475"><span class="hs-identifier hs-var">allDone</span></a><span> </span><a href="#local-6989586621679073496"><span class="hs-identifier hs-var">count</span></a><span>
</span><a name="line-803"></a><span>
</span><a name="line-804"></a><span>  </span><span class="hs-comment">-- Return the result or throw an exception. Yes, we could use</span><span>
</span><a name="line-805"></a><span>  </span><span class="hs-comment">-- either or join, but explicit pattern matching is nicer here.</span><span>
</span><a name="line-806"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679073493"><span class="hs-identifier hs-var">res</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-807"></a><span>    </span><span class="hs-comment">-- Parent thread was killed with an async exception</span><span>
</span><a name="line-808"></a><span>    </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679073497"><a href="#local-6989586621679073497"><span class="hs-identifier">e</span></a></a><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">E.throwIO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073497"><span class="hs-identifier hs-var">e</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">E.SomeException</span><span class="hs-special">)</span><span>
</span><a name="line-809"></a><span>    </span><span class="hs-comment">-- Some child thread died</span><span>
</span><a name="line-810"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621679073498"><a href="#local-6989586621679073498"><span class="hs-identifier">e</span></a></a><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">E.throwIO</span><span> </span><a href="#local-6989586621679073498"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-811"></a><span>    </span><span class="hs-comment">-- Everything worked!</span><span>
</span><a name="line-812"></a><span>    </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621679073499"><a href="#local-6989586621679073499"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">pure</span><span> </span><a href="#local-6989586621679073499"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-813"></a><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="hs-pragma">runFlat</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-814"></a><span>
</span><a name="line-815"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-816"></a><span class="hs-cpp">#else
</span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-818"></a><span>
</span><a name="line-819"></a><span class="hs-comment">-- | Unlifted 'A.mapConcurrently'.</span><span>
</span><a name="line-820"></a><span class="hs-comment">--</span><span>
</span><a name="line-821"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-822"></a><span class="hs-identifier">mapConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">MonadUnliftIO</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Traversable</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">t</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span>
</span><a name="line-823"></a><span class="hs-identifier">mapConcurrently</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withRunInIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">run</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">A.mapConcurrently</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">run</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">f</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">t</span><span>
</span><a name="line-824"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mapConcurrently</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-825"></a><span>
</span><a name="line-826"></a><span class="hs-comment">-- | Unlifted 'A.mapConcurrently_'.</span><span>
</span><a name="line-827"></a><span class="hs-comment">--</span><span>
</span><a name="line-828"></a><span class="hs-comment">-- @since 0.1.0.0</span><span>
</span><a name="line-829"></a><span class="hs-identifier">mapConcurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">MonadUnliftIO</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">Foldable</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-identifier">b</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">m</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-830"></a><span class="hs-identifier">mapConcurrently_</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">t</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">withRunInIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">run</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">A.mapConcurrently_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">run</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">f</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">t</span><span>
</span><a name="line-831"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">mapConcurrently_</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-832"></a><span>
</span><a name="line-833"></a><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-834"></a><span class="hs-cpp">#endif
</span><span class="hs-comment">--------------------------------------------------------------------------------</span><span>
</span><a name="line-836"></a><span>
</span><a name="line-837"></a><span class="hs-comment">-- | Like 'mapConcurrently' from async, but instead of one thread per</span><span>
</span><a name="line-838"></a><span class="hs-comment">-- element, it does pooling from a set of threads. This is useful in</span><span>
</span><a name="line-839"></a><span class="hs-comment">-- scenarios where resource consumption is bounded and for use cases</span><span>
</span><a name="line-840"></a><span class="hs-comment">-- where too many concurrent tasks aren't allowed.</span><span>
</span><a name="line-841"></a><span class="hs-comment">--</span><span>
</span><a name="line-842"></a><span class="hs-comment">-- === __Example usage__</span><span>
</span><a name="line-843"></a><span class="hs-comment">--</span><span>
</span><a name="line-844"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-845"></a><span class="hs-comment">-- import Say</span><span>
</span><a name="line-846"></a><span class="hs-comment">--</span><span>
</span><a name="line-847"></a><span class="hs-comment">-- action :: Int -&gt; IO Int</span><span>
</span><a name="line-848"></a><span class="hs-comment">-- action n = do</span><span>
</span><a name="line-849"></a><span class="hs-comment">--   tid &lt;- myThreadId</span><span>
</span><a name="line-850"></a><span class="hs-comment">--   sayString $ show tid</span><span>
</span><a name="line-851"></a><span class="hs-comment">--   threadDelay (2 * 10^6) -- 2 seconds</span><span>
</span><a name="line-852"></a><span class="hs-comment">--   return n</span><span>
</span><a name="line-853"></a><span class="hs-comment">--</span><span>
</span><a name="line-854"></a><span class="hs-comment">-- main :: IO ()</span><span>
</span><a name="line-855"></a><span class="hs-comment">-- main = do</span><span>
</span><a name="line-856"></a><span class="hs-comment">--   yx \&lt;- pooledMapConcurrentlyN 5 (\\x -\&gt; action x) [1..5]</span><span>
</span><a name="line-857"></a><span class="hs-comment">--   print yx</span><span>
</span><a name="line-858"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-859"></a><span class="hs-comment">--</span><span>
</span><a name="line-860"></a><span class="hs-comment">-- On executing you can see that five threads have been spawned:</span><span>
</span><a name="line-861"></a><span class="hs-comment">--</span><span>
</span><a name="line-862"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-863"></a><span class="hs-comment">-- \$ ./pool</span><span>
</span><a name="line-864"></a><span class="hs-comment">-- ThreadId 36</span><span>
</span><a name="line-865"></a><span class="hs-comment">-- ThreadId 38</span><span>
</span><a name="line-866"></a><span class="hs-comment">-- ThreadId 40</span><span>
</span><a name="line-867"></a><span class="hs-comment">-- ThreadId 42</span><span>
</span><a name="line-868"></a><span class="hs-comment">-- ThreadId 44</span><span>
</span><a name="line-869"></a><span class="hs-comment">-- [1,2,3,4,5]</span><span>
</span><a name="line-870"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-871"></a><span class="hs-comment">--</span><span>
</span><a name="line-872"></a><span class="hs-comment">--</span><span>
</span><a name="line-873"></a><span class="hs-comment">-- Let's modify the above program such that there are less threads</span><span>
</span><a name="line-874"></a><span class="hs-comment">-- than the number of items in the list:</span><span>
</span><a name="line-875"></a><span class="hs-comment">--</span><span>
</span><a name="line-876"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-877"></a><span class="hs-comment">-- import Say</span><span>
</span><a name="line-878"></a><span class="hs-comment">--</span><span>
</span><a name="line-879"></a><span class="hs-comment">-- action :: Int -&gt; IO Int</span><span>
</span><a name="line-880"></a><span class="hs-comment">-- action n = do</span><span>
</span><a name="line-881"></a><span class="hs-comment">--   tid &lt;- myThreadId</span><span>
</span><a name="line-882"></a><span class="hs-comment">--   sayString $ show tid</span><span>
</span><a name="line-883"></a><span class="hs-comment">--   threadDelay (2 * 10^6) -- 2 seconds</span><span>
</span><a name="line-884"></a><span class="hs-comment">--   return n</span><span>
</span><a name="line-885"></a><span class="hs-comment">--</span><span>
</span><a name="line-886"></a><span class="hs-comment">-- main :: IO ()</span><span>
</span><a name="line-887"></a><span class="hs-comment">-- main = do</span><span>
</span><a name="line-888"></a><span class="hs-comment">--   yx \&lt;- pooledMapConcurrentlyN 3 (\\x -\&gt; action x) [1..5]</span><span>
</span><a name="line-889"></a><span class="hs-comment">--   print yx</span><span>
</span><a name="line-890"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-891"></a><span class="hs-comment">-- On executing you can see that only three threads are active totally:</span><span>
</span><a name="line-892"></a><span class="hs-comment">--</span><span>
</span><a name="line-893"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-894"></a><span class="hs-comment">-- \$ ./pool</span><span>
</span><a name="line-895"></a><span class="hs-comment">-- ThreadId 35</span><span>
</span><a name="line-896"></a><span class="hs-comment">-- ThreadId 37</span><span>
</span><a name="line-897"></a><span class="hs-comment">-- ThreadId 39</span><span>
</span><a name="line-898"></a><span class="hs-comment">-- ThreadId 35</span><span>
</span><a name="line-899"></a><span class="hs-comment">-- ThreadId 39</span><span>
</span><a name="line-900"></a><span class="hs-comment">-- [1,2,3,4,5]</span><span>
</span><a name="line-901"></a><span class="hs-comment">-- @</span><span>
</span><a name="line-902"></a><span class="hs-comment">--</span><span>
</span><a name="line-903"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-904"></a><span class="hs-identifier">pooledMapConcurrentlyN</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072909"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679072910"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-905"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Max. number of threads. Should not be less than 1.</span><span>
</span><a name="line-906"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072911"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072909"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072912"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072910"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072911"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072909"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072910"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072912"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-907"></a><a name="pooledMapConcurrentlyN"><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyN"><span class="hs-identifier">pooledMapConcurrentlyN</span></a></a><span> </span><a name="local-6989586621679073500"><a href="#local-6989586621679073500"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073501"><a href="#local-6989586621679073501"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073502"><a href="#local-6989586621679073502"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-908"></a><span>    </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073503"><a href="#local-6989586621679073503"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO"><span class="hs-identifier hs-var">pooledMapConcurrentlyIO</span></a><span> </span><a href="#local-6989586621679073500"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073503"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073501"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073502"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-909"></a><span>
</span><a name="line-910"></a><span class="hs-comment">-- | Similar to 'pooledMapConcurrentlyN' but with number of threads</span><span>
</span><a name="line-911"></a><span class="hs-comment">-- set from 'getNumCapabilities'. Usually this is useful for CPU bound</span><span>
</span><a name="line-912"></a><span class="hs-comment">-- tasks.</span><span>
</span><a name="line-913"></a><span class="hs-comment">--</span><span>
</span><a name="line-914"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-915"></a><span class="hs-identifier">pooledMapConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072905"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679072906"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072907"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072905"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072908"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072906"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072907"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072905"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072906"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072908"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-916"></a><a name="pooledMapConcurrently"><a href="UnliftIO.Internals.Async.html#pooledMapConcurrently"><span class="hs-identifier">pooledMapConcurrently</span></a></a><span> </span><a name="local-6989586621679073504"><a href="#local-6989586621679073504"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073505"><a href="#local-6989586621679073505"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-917"></a><span>  </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073506"><a href="#local-6989586621679073506"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-918"></a><span>    </span><a name="local-6989586621679073507"><a href="#local-6989586621679073507"><span class="hs-identifier">numProcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getNumCapabilities</span><span>
</span><a name="line-919"></a><span>    </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO"><span class="hs-identifier hs-var">pooledMapConcurrentlyIO</span></a><span> </span><a href="#local-6989586621679073507"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073506"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073504"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073505"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-920"></a><span>
</span><a name="line-921"></a><span class="hs-comment">-- | Similar to 'pooledMapConcurrentlyN' but with flipped arguments.</span><span>
</span><a name="line-922"></a><span class="hs-comment">--</span><span>
</span><a name="line-923"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-924"></a><span class="hs-identifier">pooledForConcurrentlyN</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072901"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679072902"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-925"></a><span>                      </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Max. number of threads. Should not be less than 1.</span><span>
</span><a name="line-926"></a><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072902"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072903"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072903"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072901"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072904"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072901"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072902"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072904"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-927"></a><a name="pooledForConcurrentlyN"><a href="UnliftIO.Internals.Async.html#pooledForConcurrentlyN"><span class="hs-identifier">pooledForConcurrentlyN</span></a></a><span> </span><a name="local-6989586621679073508"><a href="#local-6989586621679073508"><span class="hs-identifier">numProcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyN"><span class="hs-identifier hs-var">pooledMapConcurrentlyN</span></a><span> </span><a href="#local-6989586621679073508"><span class="hs-identifier hs-var">numProcs</span></a><span class="hs-special">)</span><span>
</span><a name="line-928"></a><span>
</span><a name="line-929"></a><span class="hs-comment">-- | Similar to 'pooledForConcurrentlyN' but with number of threads</span><span>
</span><a name="line-930"></a><span class="hs-comment">-- set from 'getNumCapabilities'. Usually this is useful for CPU bound</span><span>
</span><a name="line-931"></a><span class="hs-comment">-- tasks.</span><span>
</span><a name="line-932"></a><span class="hs-comment">--</span><span>
</span><a name="line-933"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-934"></a><span class="hs-identifier">pooledForConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072897"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679072898"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679072898"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072899"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072899"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072897"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072900"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072897"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072898"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072900"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-935"></a><a name="pooledForConcurrently"><a href="UnliftIO.Internals.Async.html#pooledForConcurrently"><span class="hs-identifier">pooledForConcurrently</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrently"><span class="hs-identifier hs-var">pooledMapConcurrently</span></a><span>
</span><a name="line-936"></a><span>
</span><a name="line-937"></a><span class="hs-identifier">pooledMapConcurrentlyIO</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679072894"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072895"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679072896"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072894"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072895"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072894"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072896"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-938"></a><a name="pooledMapConcurrentlyIO"><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO"><span class="hs-identifier">pooledMapConcurrentlyIO</span></a></a><span> </span><a name="local-6989586621679073509"><a href="#local-6989586621679073509"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073510"><a href="#local-6989586621679073510"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073511"><a href="#local-6989586621679073511"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-939"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073509"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-940"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;pooledMapconcurrentlyIO: number of threads &lt; 1&quot;</span><span>
</span><a name="line-941"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO%27"><span class="hs-identifier hs-var">pooledMapConcurrentlyIO'</span></a><span> </span><a href="#local-6989586621679073509"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><a href="#local-6989586621679073510"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073511"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-942"></a><span>
</span><a name="line-943"></a><span class="hs-comment">-- | Performs the actual pooling for the tasks. This function will</span><span>
</span><a name="line-944"></a><span class="hs-comment">-- continue execution until the task queue becomes empty. When one of</span><span>
</span><a name="line-945"></a><span class="hs-comment">-- the pooled thread finishes it's task, it will pickup the next task</span><span>
</span><a name="line-946"></a><span class="hs-comment">-- from the queue if an job is available.</span><span>
</span><a name="line-947"></a><span class="hs-identifier">pooledConcurrently</span><span>
</span><a name="line-948"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Max. number of threads. Should not be less than 1.</span><span>
</span><a name="line-949"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679072893"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ Task queue. These are required as inputs for the jobs.</span><span>
</span><a name="line-950"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072893"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The task which will be run concurrently (but</span><span>
</span><a name="line-951"></a><span>                 </span><span class="hs-comment">-- will be pooled properly).</span><span>
</span><a name="line-952"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-953"></a><a name="pooledConcurrently"><a href="UnliftIO.Internals.Async.html#pooledConcurrently"><span class="hs-identifier">pooledConcurrently</span></a></a><span> </span><a name="local-6989586621679073512"><a href="#local-6989586621679073512"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073513"><a href="#local-6989586621679073513"><span class="hs-identifier">jobsVar</span></a></a><span> </span><a name="local-6989586621679073514"><a href="#local-6989586621679073514"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-954"></a><span>  </span><a href="UnliftIO.Internals.Async.html#replicateConcurrently_"><span class="hs-identifier hs-var">replicateConcurrently_</span></a><span> </span><a href="#local-6989586621679073512"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-955"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679073515"><a href="#local-6989586621679073515"><span class="hs-identifier">loop</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-956"></a><span>          </span><a name="local-6989586621679073520"><a href="#local-6989586621679073520"><span class="hs-identifier">mbJob</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="#local-6989586621679073519"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">atomicModifyIORef'</span><span> </span><a href="#local-6989586621679073513"><span class="hs-identifier hs-var">jobsVar</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073516"><a href="#local-6989586621679073516"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679073516"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-957"></a><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span>
</span><a name="line-958"></a><span>            </span><a name="local-6989586621679073517"><a href="#local-6989586621679073517"><span class="hs-identifier">var</span></a></a><span> </span><span class="hs-glyph">:</span><span> </span><a name="local-6989586621679073518"><a href="#local-6989586621679073518"><span class="hs-identifier">vars</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073518"><span class="hs-identifier hs-var">vars</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679073517"><span class="hs-identifier hs-var">var</span></a><span class="hs-special">)</span><span>
</span><a name="line-959"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679073520"><span class="hs-identifier hs-var">mbJob</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-960"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-961"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679073521"><a href="#local-6989586621679073521"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-962"></a><span>              </span><a href="#local-6989586621679073514"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073521"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-963"></a><span>              </span><a href="#local-6989586621679073515"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-964"></a><span>     </span><span class="hs-keyword">in</span><span> </span><a href="#local-6989586621679073515"><span class="hs-identifier hs-var">loop</span></a><span>
</span><a name="line-965"></a><span>
</span><a name="line-966"></a><span class="hs-identifier">pooledMapConcurrentlyIO'</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-967"></a><span>    </span><span class="hs-identifier hs-type">Traversable</span><span> </span><a href="#local-6989586621679072890"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span>  </span><span class="hs-comment">-- ^ Max. number of threads. Should not be less than 1.</span><span>
</span><a name="line-968"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072891"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679072892"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-969"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072890"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072891"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-970"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072890"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072892"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span>
</span><a name="line-971"></a><a name="pooledMapConcurrentlyIO%27"><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO%27"><span class="hs-identifier">pooledMapConcurrentlyIO'</span></a></a><span> </span><a name="local-6989586621679073522"><a href="#local-6989586621679073522"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073523"><a href="#local-6989586621679073523"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073524"><a href="#local-6989586621679073524"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-972"></a><span>  </span><span class="hs-comment">-- prepare one IORef per result...</span><span>
</span><a name="line-973"></a><span>  </span><a name="local-6989586621679073529"><a href="#local-6989586621679073529"><span class="hs-identifier">jobs</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679073526"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073527"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="#local-6989586621679073528"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><a name="line-974"></a><span>    </span><span class="hs-identifier hs-var">for</span><span> </span><a href="#local-6989586621679073524"><span class="hs-identifier hs-var">xs</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679073525"><a href="#local-6989586621679073525"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073525"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;pooledMapConcurrentlyIO': empty IORef&quot;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-975"></a><span>  </span><span class="hs-comment">-- ...put all the inputs in a queue..</span><span>
</span><a name="line-976"></a><span>  </span><a name="local-6989586621679073530"><a href="#local-6989586621679073530"><span class="hs-identifier">jobsVar</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679073527"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><a href="#local-6989586621679073528"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679073529"><span class="hs-identifier hs-var">jobs</span></a><span class="hs-special">)</span><span>
</span><a name="line-977"></a><span>  </span><span class="hs-comment">-- ...run `numProcs` threads in parallel, each</span><span>
</span><a name="line-978"></a><span>  </span><span class="hs-comment">-- of them consuming the queue and filling in</span><span>
</span><a name="line-979"></a><span>  </span><span class="hs-comment">-- the respective IORefs.</span><span>
</span><a name="line-980"></a><span>  </span><a href="UnliftIO.Internals.Async.html#pooledConcurrently"><span class="hs-identifier hs-var">pooledConcurrently</span></a><span> </span><a href="#local-6989586621679073522"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><a href="#local-6989586621679073530"><span class="hs-identifier hs-var">jobsVar</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679073531"><a href="#local-6989586621679073531"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679073532"><a href="#local-6989586621679073532"><span class="hs-identifier">outRef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073523"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073531"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">atomicWriteIORef</span><span> </span><a href="#local-6989586621679073532"><span class="hs-identifier hs-var">outRef</span></a><span>      </span><span class="hs-comment">-- Read all the IORefs</span><span>
</span><a name="line-981"></a><span>  </span><span class="hs-identifier hs-var">for</span><span> </span><a href="#local-6989586621679073529"><span class="hs-identifier hs-var">jobs</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679073533"><a href="#local-6989586621679073533"><span class="hs-identifier">outputRef</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">readIORef</span><span> </span><a href="#local-6989586621679073533"><span class="hs-identifier hs-var">outputRef</span></a><span class="hs-special">)</span><span>
</span><a name="line-982"></a><span>
</span><a name="line-983"></a><span class="hs-identifier">pooledMapConcurrentlyIO_'</span><span> </span><span class="hs-glyph">::</span><span>
</span><a name="line-984"></a><span>  </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679072888"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072889"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072888"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072889"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-985"></a><a name="pooledMapConcurrentlyIO_%27"><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO_%27"><span class="hs-identifier">pooledMapConcurrentlyIO_'</span></a></a><span> </span><a name="local-6989586621679073534"><a href="#local-6989586621679073534"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073535"><a href="#local-6989586621679073535"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073536"><a href="#local-6989586621679073536"><span class="hs-identifier">jobs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-986"></a><span>  </span><a name="local-6989586621679073538"><a href="#local-6989586621679073538"><span class="hs-identifier">jobsVar</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IORef</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679073537"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">newIORef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toList</span><span> </span><a href="#local-6989586621679073536"><span class="hs-identifier hs-var">jobs</span></a><span class="hs-special">)</span><span>
</span><a name="line-987"></a><span>  </span><a href="UnliftIO.Internals.Async.html#pooledConcurrently"><span class="hs-identifier hs-var">pooledConcurrently</span></a><span> </span><a href="#local-6989586621679073534"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><a href="#local-6989586621679073538"><span class="hs-identifier hs-var">jobsVar</span></a><span> </span><a href="#local-6989586621679073535"><span class="hs-identifier hs-var">f</span></a><span>
</span><a name="line-988"></a><span>
</span><a name="line-989"></a><span class="hs-identifier">pooledMapConcurrentlyIO_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679072885"><span class="hs-identifier hs-type">t</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072886"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><a href="#local-6989586621679072887"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072885"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072886"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-990"></a><a name="pooledMapConcurrentlyIO_"><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO_"><span class="hs-identifier">pooledMapConcurrentlyIO_</span></a></a><span> </span><a name="local-6989586621679073539"><a href="#local-6989586621679073539"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073540"><a href="#local-6989586621679073540"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073541"><a href="#local-6989586621679073541"><span class="hs-identifier">xs</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-991"></a><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073539"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-992"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;pooledMapconcurrentlyIO_: number of threads &lt; 1&quot;</span><span>
</span><a name="line-993"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO_%27"><span class="hs-identifier hs-var">pooledMapConcurrentlyIO_'</span></a><span> </span><a href="#local-6989586621679073539"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679073542"><a href="#local-6989586621679073542"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073540"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-6989586621679073542"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073541"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-994"></a><span>
</span><a name="line-995"></a><span class="hs-comment">-- | Like 'pooledMapConcurrentlyN' but with the return value</span><span>
</span><a name="line-996"></a><span class="hs-comment">-- discarded.</span><span>
</span><a name="line-997"></a><span class="hs-comment">--</span><span>
</span><a name="line-998"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-999"></a><span class="hs-identifier">pooledMapConcurrentlyN_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072881"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679072882"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span>
</span><a name="line-1000"></a><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Max. number of threads. Should not be less than 1.</span><span>
</span><a name="line-1001"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072883"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072881"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072884"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072882"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679072883"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072881"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1002"></a><a name="pooledMapConcurrentlyN_"><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyN_"><span class="hs-identifier">pooledMapConcurrentlyN_</span></a></a><span> </span><a name="local-6989586621679073543"><a href="#local-6989586621679073543"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073544"><a href="#local-6989586621679073544"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073545"><a href="#local-6989586621679073545"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1003"></a><span>  </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073546"><a href="#local-6989586621679073546"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO_"><span class="hs-identifier hs-var">pooledMapConcurrentlyIO_</span></a><span> </span><a href="#local-6989586621679073543"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073546"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073544"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073545"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1004"></a><span>
</span><a name="line-1005"></a><span class="hs-comment">-- | Like 'pooledMapConcurrently' but with the return value discarded.</span><span>
</span><a name="line-1006"></a><span class="hs-comment">--</span><span>
</span><a name="line-1007"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-1008"></a><span class="hs-identifier">pooledMapConcurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072877"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679072878"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072879"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072877"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072880"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072878"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679072879"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072877"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1009"></a><a name="pooledMapConcurrently_"><a href="UnliftIO.Internals.Async.html#pooledMapConcurrently_"><span class="hs-identifier">pooledMapConcurrently_</span></a></a><span> </span><a name="local-6989586621679073547"><a href="#local-6989586621679073547"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679073548"><a href="#local-6989586621679073548"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1010"></a><span>  </span><span class="hs-identifier hs-var">withRunInIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621679073549"><a href="#local-6989586621679073549"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-1011"></a><span>    </span><a name="local-6989586621679073550"><a href="#local-6989586621679073550"><span class="hs-identifier">numProcs</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getNumCapabilities</span><span>
</span><a name="line-1012"></a><span>    </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyIO_"><span class="hs-identifier hs-var">pooledMapConcurrentlyIO_</span></a><span> </span><a href="#local-6989586621679073550"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679073549"><span class="hs-identifier hs-var">run</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="#local-6989586621679073547"><span class="hs-identifier hs-var">f</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679073548"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-1013"></a><span>
</span><a name="line-1014"></a><span class="hs-comment">-- | Like 'pooledMapConcurrently_' but with flipped arguments.</span><span>
</span><a name="line-1015"></a><span class="hs-comment">--</span><span>
</span><a name="line-1016"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-1017"></a><span class="hs-identifier">pooledForConcurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072873"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679072874"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679072874"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679072875"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072875"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072873"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072876"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072873"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1018"></a><a name="pooledForConcurrently_"><a href="UnliftIO.Internals.Async.html#pooledForConcurrently_"><span class="hs-identifier">pooledForConcurrently_</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrently_"><span class="hs-identifier hs-var">pooledMapConcurrently_</span></a><span>
</span><a name="line-1019"></a><span>
</span><a name="line-1020"></a><span class="hs-comment">-- | Like 'pooledMapConcurrentlyN_' but with flipped arguments.</span><span>
</span><a name="line-1021"></a><span class="hs-comment">--</span><span>
</span><a name="line-1022"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-1023"></a><span class="hs-identifier">pooledForConcurrentlyN_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072869"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Foldable</span><span> </span><a href="#local-6989586621679072870"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-1024"></a><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Max. number of threads. Should not be less than 1.</span><span>
</span><a name="line-1025"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072870"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-6989586621679072871"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679072871"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072869"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072872"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072869"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1026"></a><a name="pooledForConcurrentlyN_"><a href="UnliftIO.Internals.Async.html#pooledForConcurrentlyN_"><span class="hs-identifier">pooledForConcurrentlyN_</span></a></a><span> </span><a name="local-6989586621679073551"><a href="#local-6989586621679073551"><span class="hs-identifier">numProcs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-special">(</span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyN_"><span class="hs-identifier hs-var">pooledMapConcurrentlyN_</span></a><span> </span><a href="#local-6989586621679073551"><span class="hs-identifier hs-var">numProcs</span></a><span class="hs-special">)</span><span>
</span><a name="line-1027"></a><span>
</span><a name="line-1028"></a><span>
</span><a name="line-1029"></a><span class="hs-comment">-- | Pooled version of 'replicateConcurrently'. Performs the action in</span><span>
</span><a name="line-1030"></a><span class="hs-comment">-- the pooled threads.</span><span>
</span><a name="line-1031"></a><span class="hs-comment">--</span><span>
</span><a name="line-1032"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-1033"></a><span class="hs-identifier">pooledReplicateConcurrentlyN</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072867"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1034"></a><span>                             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Max. number of threads. Should not be less than 1.</span><span>
</span><a name="line-1035"></a><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Number of times to perform the action.</span><span>
</span><a name="line-1036"></a><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072867"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072868"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072867"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679072868"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1037"></a><a name="pooledReplicateConcurrentlyN"><a href="UnliftIO.Internals.Async.html#pooledReplicateConcurrentlyN"><span class="hs-identifier">pooledReplicateConcurrentlyN</span></a></a><span> </span><a name="local-6989586621679073552"><a href="#local-6989586621679073552"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073553"><a href="#local-6989586621679073553"><span class="hs-identifier">cnt</span></a></a><span> </span><a name="local-6989586621679073554"><a href="#local-6989586621679073554"><span class="hs-identifier">task</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1038"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679073553"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1039"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1040"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyN"><span class="hs-identifier hs-var">pooledMapConcurrentlyN</span></a><span> </span><a href="#local-6989586621679073552"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073554"><span class="hs-identifier hs-var">task</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><a href="#local-6989586621679073553"><span class="hs-identifier hs-var">cnt</span></a><span class="hs-special">]</span><span>
</span><a name="line-1041"></a><span>
</span><a name="line-1042"></a><span class="hs-comment">-- | Similar to 'pooledReplicateConcurrentlyN' but with number of</span><span>
</span><a name="line-1043"></a><span class="hs-comment">-- threads set from 'getNumCapabilities'. Usually this is useful for</span><span>
</span><a name="line-1044"></a><span class="hs-comment">-- CPU bound tasks.</span><span>
</span><a name="line-1045"></a><span class="hs-comment">--</span><span>
</span><a name="line-1046"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-1047"></a><span class="hs-identifier">pooledReplicateConcurrently</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072865"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1048"></a><span>                            </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Number of times to perform the action.</span><span>
</span><a name="line-1049"></a><span>                            </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072865"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072866"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072865"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">[</span><a href="#local-6989586621679072866"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">]</span><span>
</span><a name="line-1050"></a><a name="pooledReplicateConcurrently"><a href="UnliftIO.Internals.Async.html#pooledReplicateConcurrently"><span class="hs-identifier">pooledReplicateConcurrently</span></a></a><span> </span><a name="local-6989586621679073555"><a href="#local-6989586621679073555"><span class="hs-identifier">cnt</span></a></a><span> </span><a name="local-6989586621679073556"><a href="#local-6989586621679073556"><span class="hs-identifier">task</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1051"></a><span>    </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679073555"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1052"></a><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-1053"></a><span>    </span><span class="hs-keyword">else</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrently"><span class="hs-identifier hs-var">pooledMapConcurrently</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073556"><span class="hs-identifier hs-var">task</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><a href="#local-6989586621679073555"><span class="hs-identifier hs-var">cnt</span></a><span class="hs-special">]</span><span>
</span><a name="line-1054"></a><span>
</span><a name="line-1055"></a><span class="hs-comment">-- | Pooled version of 'replicateConcurrently_'. Performs the action in</span><span>
</span><a name="line-1056"></a><span class="hs-comment">-- the pooled threads.</span><span>
</span><a name="line-1057"></a><span class="hs-comment">--</span><span>
</span><a name="line-1058"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-1059"></a><span class="hs-identifier">pooledReplicateConcurrentlyN_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072863"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1060"></a><span>                              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Max. number of threads. Should not be less than 1.</span><span>
</span><a name="line-1061"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Number of times to perform the action.</span><span>
</span><a name="line-1062"></a><span>                              </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072863"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072864"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072863"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1063"></a><a name="pooledReplicateConcurrentlyN_"><a href="UnliftIO.Internals.Async.html#pooledReplicateConcurrentlyN_"><span class="hs-identifier">pooledReplicateConcurrentlyN_</span></a></a><span> </span><a name="local-6989586621679073557"><a href="#local-6989586621679073557"><span class="hs-identifier">numProcs</span></a></a><span> </span><a name="local-6989586621679073558"><a href="#local-6989586621679073558"><span class="hs-identifier">cnt</span></a></a><span> </span><a name="local-6989586621679073559"><a href="#local-6989586621679073559"><span class="hs-identifier">task</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1064"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679073558"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1065"></a><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1066"></a><span>  </span><span class="hs-keyword">else</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrentlyN_"><span class="hs-identifier hs-var">pooledMapConcurrentlyN_</span></a><span> </span><a href="#local-6989586621679073557"><span class="hs-identifier hs-var">numProcs</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073559"><span class="hs-identifier hs-var">task</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><a href="#local-6989586621679073558"><span class="hs-identifier hs-var">cnt</span></a><span class="hs-special">]</span><span>
</span><a name="line-1067"></a><span>
</span><a name="line-1068"></a><span class="hs-comment">-- | Similar to 'pooledReplicateConcurrently_' but with number of</span><span>
</span><a name="line-1069"></a><span class="hs-comment">-- threads set from 'getNumCapabilities'. Usually this is useful for</span><span>
</span><a name="line-1070"></a><span class="hs-comment">-- CPU bound tasks.</span><span>
</span><a name="line-1071"></a><span class="hs-comment">--</span><span>
</span><a name="line-1072"></a><span class="hs-comment">-- @since 0.2.10</span><span>
</span><a name="line-1073"></a><span class="hs-identifier">pooledReplicateConcurrently_</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadUnliftIO</span><span> </span><a href="#local-6989586621679072861"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-1074"></a><span>                             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Int</span><span> </span><span class="hs-comment">-- ^ Number of times to perform the action.</span><span>
</span><a name="line-1075"></a><span>                             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072861"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="#local-6989586621679072862"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679072861"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1076"></a><a name="pooledReplicateConcurrently_"><a href="UnliftIO.Internals.Async.html#pooledReplicateConcurrently_"><span class="hs-identifier">pooledReplicateConcurrently_</span></a></a><span> </span><a name="local-6989586621679073560"><a href="#local-6989586621679073560"><span class="hs-identifier">cnt</span></a></a><span> </span><a name="local-6989586621679073561"><a href="#local-6989586621679073561"><span class="hs-identifier">task</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-1077"></a><span>  </span><span class="hs-keyword">if</span><span> </span><a href="#local-6989586621679073560"><span class="hs-identifier hs-var">cnt</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">1</span><span>
</span><a name="line-1078"></a><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-1079"></a><span>  </span><span class="hs-keyword">else</span><span> </span><a href="UnliftIO.Internals.Async.html#pooledMapConcurrently_"><span class="hs-identifier hs-var">pooledMapConcurrently_</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679073561"><span class="hs-identifier hs-var">task</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><a href="#local-6989586621679073560"><span class="hs-identifier hs-var">cnt</span></a><span class="hs-special">]</span><span>
</span><a name="line-1080"></a></pre></body></html>