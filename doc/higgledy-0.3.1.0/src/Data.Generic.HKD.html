<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE MonoLocalBinds      #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-comment">{-|
Module      : Data.Generic.HKD
Description : A generic-based HKD decorator for ADTs.
Copyright   : (c) Tom Harding, 2019
License     : MIT
Maintainer  : tom.harding@habito.com
Stability   : experimental
-}</span><span>
</span><a name="line-15"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Generic.HKD</span><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Exports</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Barbie.ConstraintsB</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Barbie.FunctorB</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Barbie.ProductBC</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Barbie.TraversableB</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Generic.HKD.html#position"><span class="hs-identifier hs-var">position</span></a><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.Generic.HKD.html#field"><span class="hs-identifier hs-var">field</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-26"></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Generic.HKD.Build.html"><span class="hs-identifier">Data.Generic.HKD.Build</span></a><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exports</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Generic.HKD.Construction.html"><span class="hs-identifier">Data.Generic.HKD.Construction</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exports</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Generic.HKD.Labels.html"><span class="hs-identifier">Data.Generic.HKD.Labels</span></a><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exports</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Generic.HKD.Named.html"><span class="hs-identifier">Data.Generic.HKD.Named</span></a><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exports</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Data.Generic.HKD.Types.html"><span class="hs-identifier">Data.Generic.HKD.Types</span></a><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Exports</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Barbie</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Barbie</span><span>
</span><a name="line-34"></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Generics.Internal.VL.Lens</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">G</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Generics.Product</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">G</span><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span class="hs-comment">-- | When we work with records, all the fields are named, and we can refer to</span><span>
</span><a name="line-39"></a><span class="hs-comment">-- them using these names. This class provides a lens from our HKD structure to</span><span>
</span><a name="line-40"></a><span class="hs-comment">-- any @f@-wrapped field.</span><span>
</span><a name="line-41"></a><span class="hs-comment">--</span><span>
</span><a name="line-42"></a><span class="hs-comment">-- &gt;&gt;&gt; :set -XDataKinds -XDeriveGeneric -XTypeApplications</span><span>
</span><a name="line-43"></a><span class="hs-comment">-- &gt;&gt;&gt; import Control.Lens ((&amp;), (.~))</span><span>
</span><a name="line-44"></a><span class="hs-comment">-- &gt;&gt;&gt; import Data.Monoid (Last)</span><span>
</span><a name="line-45"></a><span class="hs-comment">-- &gt;&gt;&gt; import GHC.Generics</span><span>
</span><a name="line-46"></a><span class="hs-comment">--</span><span>
</span><a name="line-47"></a><span class="hs-comment">-- &gt;&gt;&gt; data User = User { name :: String, age :: Int } deriving (Generic, Show)</span><span>
</span><a name="line-48"></a><span class="hs-comment">-- &gt;&gt;&gt; type Partial a = HKD a Last</span><span>
</span><a name="line-49"></a><span class="hs-comment">--</span><span>
</span><a name="line-50"></a><span class="hs-comment">-- We can create an empty partial @User@ and set its name to \&quot;Tom\&quot; (which, in</span><span>
</span><a name="line-51"></a><span class="hs-comment">-- this case, is @pure \&quot;Tom\&quot; :: Last String@):</span><span>
</span><a name="line-52"></a><span class="hs-comment">--</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- &gt;&gt;&gt; mempty @(Partial User) &amp; field @&quot;name&quot; .~ pure &quot;Tom&quot;</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- User {name = Last {getLast = Just &quot;Tom&quot;}, age = Last {getLast = Nothing}}</span><span>
</span><a name="line-55"></a><span class="hs-comment">--</span><span>
</span><a name="line-56"></a><span class="hs-comment">-- Thanks to some @generic-lens@ magic, we also get some pretty magical type</span><span>
</span><a name="line-57"></a><span class="hs-comment">-- errors! If we create a (complete) partial user:</span><span>
</span><a name="line-58"></a><span class="hs-comment">--</span><span>
</span><a name="line-59"></a><span class="hs-comment">-- &gt;&gt;&gt; import Data.Generic.HKD.Construction (deconstruct)</span><span>
</span><a name="line-60"></a><span class="hs-comment">-- &gt;&gt;&gt; total = deconstruct @Last (User &quot;Tom&quot; 25)</span><span>
</span><a name="line-61"></a><span class="hs-comment">--</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- ... and then try to access a field that isn't there, we get a friendly</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- message to point us in the right direction:</span><span>
</span><a name="line-64"></a><span class="hs-comment">--</span><span>
</span><a name="line-65"></a><span class="hs-comment">-- &gt;&gt;&gt; total &amp; field @&quot;oops&quot; .~ pure ()</span><span>
</span><a name="line-66"></a><span class="hs-comment">-- ...</span><span>
</span><a name="line-67"></a><span class="hs-comment">-- ... error:</span><span>
</span><a name="line-68"></a><span class="hs-comment">-- ... The type HKD User Last does not contain a field named 'oops'.</span><span>
</span><a name="line-69"></a><span class="hs-comment">-- ...</span><span>
</span><a name="line-70"></a><span class="hs-identifier">field</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679064773"><a href="#local-6989586621679064773"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679064774"><a href="#local-6989586621679064774"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679064775"><a href="#local-6989586621679064775"><span class="hs-identifier">structure</span></a></a><span> </span><a name="local-6989586621679064776"><a href="#local-6989586621679064776"><span class="hs-identifier">inner</span></a></a><span>
</span><a name="line-72"></a><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">G.HasField'</span><span> </span><a href="#local-6989586621679064773"><span class="hs-identifier hs-type">field</span></a><span> </span><span class="hs-special">(</span><a href="Data.Generic.HKD.Types.html#HKD"><span class="hs-identifier hs-type">HKD</span></a><span> </span><a href="#local-6989586621679064775"><span class="hs-identifier hs-type">structure</span></a><span> </span><a href="#local-6989586621679064774"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679064774"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679064776"><span class="hs-identifier hs-type">inner</span></a><span class="hs-special">)</span><span>
</span><a name="line-73"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">G.Lens'</span><span> </span><span class="hs-special">(</span><a href="Data.Generic.HKD.Types.html#HKD"><span class="hs-identifier hs-type">HKD</span></a><span> </span><a href="#local-6989586621679064775"><span class="hs-identifier hs-type">structure</span></a><span> </span><a href="#local-6989586621679064774"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679064774"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679064776"><span class="hs-identifier hs-type">inner</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><a name="field"><a href="Data.Generic.HKD.html#field"><span class="hs-identifier">field</span></a></a><span>
</span><a name="line-76"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">G.field'</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679064773"><span class="hs-identifier hs-type">field</span></a><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- | Product types /without/ named fields can't be addressed by field name (for</span><span>
</span><a name="line-79"></a><span class="hs-comment">-- very obvious reason), so we instead need to address them with their</span><span>
</span><a name="line-80"></a><span class="hs-comment">-- &quot;position&quot; index. This is a one-indexed type-applied natural:</span><span>
</span><a name="line-81"></a><span class="hs-comment">--</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- &gt;&gt;&gt; import Control.Lens ((^.))</span><span>
</span><a name="line-83"></a><span class="hs-comment">--</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- &gt;&gt;&gt; :t mempty @(HKD (Int, String) []) ^. position @1</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- mempty @(HKD (Int, String) []) ^. position @1 :: [Int]</span><span>
</span><a name="line-86"></a><span class="hs-comment">--</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- As we're using the wonderful @generic-lens@ library under the hood, we also</span><span>
</span><a name="line-88"></a><span class="hs-comment">-- get some beautiful error messages when things go awry:</span><span>
</span><a name="line-89"></a><span class="hs-comment">--</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- &gt;&gt;&gt; import Data.Generic.HKD.Construction</span><span>
</span><a name="line-91"></a><span class="hs-comment">-- &gt;&gt;&gt; deconstruct (&quot;Hello&quot;, True) ^. position @4</span><span>
</span><a name="line-92"></a><span class="hs-comment">-- ...</span><span>
</span><a name="line-93"></a><span class="hs-comment">-- ... error:</span><span>
</span><a name="line-94"></a><span class="hs-comment">-- ... The type HKD</span><span>
</span><a name="line-95"></a><span class="hs-comment">-- ... ([Char], Bool) f does not contain a field at position 4</span><span>
</span><a name="line-96"></a><span class="hs-comment">-- ...</span><span>
</span><a name="line-97"></a><span class="hs-identifier">position</span><span>
</span><a name="line-98"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679064769"><a href="#local-6989586621679064769"><span class="hs-identifier">index</span></a></a><span> </span><a name="local-6989586621679064770"><a href="#local-6989586621679064770"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-6989586621679064771"><a href="#local-6989586621679064771"><span class="hs-identifier">structure</span></a></a><span> </span><a name="local-6989586621679064772"><a href="#local-6989586621679064772"><span class="hs-identifier">inner</span></a></a><span>
</span><a name="line-99"></a><span>   </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier hs-type">G.HasPosition'</span><span> </span><a href="#local-6989586621679064769"><span class="hs-identifier hs-type">index</span></a><span> </span><span class="hs-special">(</span><a href="Data.Generic.HKD.Types.html#HKD"><span class="hs-identifier hs-type">HKD</span></a><span> </span><a href="#local-6989586621679064771"><span class="hs-identifier hs-type">structure</span></a><span> </span><a href="#local-6989586621679064770"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679064770"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679064772"><span class="hs-identifier hs-type">inner</span></a><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">G.Lens'</span><span> </span><span class="hs-special">(</span><a href="Data.Generic.HKD.Types.html#HKD"><span class="hs-identifier hs-type">HKD</span></a><span> </span><a href="#local-6989586621679064771"><span class="hs-identifier hs-type">structure</span></a><span> </span><a href="#local-6989586621679064770"><span class="hs-identifier hs-type">f</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679064770"><span class="hs-identifier hs-type">f</span></a><span> </span><a href="#local-6989586621679064772"><span class="hs-identifier hs-type">inner</span></a><span class="hs-special">)</span><span>
</span><a name="line-101"></a><span>
</span><a name="line-102"></a><a name="position"><a href="Data.Generic.HKD.html#position"><span class="hs-identifier">position</span></a></a><span>
</span><a name="line-103"></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">G.position'</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679064769"><span class="hs-identifier hs-type">index</span></a><span>
</span><a name="line-104"></a></pre></body></html>