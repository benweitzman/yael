<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><a name="line-4"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ &gt;= 800
</span><span class="hs-pragma">{-# LANGUAGE TemplateHaskellQuotes #-}</span><span>
</span><a name="line-6"></a><span class="hs-cpp">#else
</span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><a name="line-8"></a><span class="hs-cpp">#endif
#if __GLASGOW_HASKELL__ &gt;= 702
</span><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><a name="line-11"></a><span class="hs-cpp">#endif
</span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# OPTIONS -Wall #-}</span><span>
</span><a name="line-15"></a><span>
</span><a name="line-16"></a><span class="hs-comment">{-|
Module:      Data.Vector.Unboxed.Deriving
Copyright:   &#169; 2012&#8722;2015 Liyang HU
License:     BSD3
Maintainer:  vector-th-unbox@liyang.hu
Stability:   experimental
Portability: non-portable
-}</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Vector.Unboxed.Deriving</span><span>
</span><a name="line-26"></a><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- $usage</span><span>
</span><a name="line-27"></a><span>      </span><a href="Data.Vector.Unboxed.Deriving.html#derivingUnbox"><span class="hs-identifier hs-var">derivingUnbox</span></a><span>
</span><a name="line-28"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span class="hs-cpp">#if !MIN_VERSION_base(4,8,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span>
</span><a name="line-32"></a><span class="hs-cpp">#endif
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Arrow</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Monad</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Char</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">isAlphaNum</span><span class="hs-special">)</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Vector.Generic</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">G</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data.Vector.Generic.Mutable</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Vector.Unboxed.Base</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MVector</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Vector</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Unbox</span><span class="hs-special">)</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Language.Haskell.TH</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-comment">-- Create a @Pat@ bound to the given name and an @Exp@ for said binding.</span><span>
</span><a name="line-42"></a><span class="hs-identifier">newPatExp</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span>
</span><a name="line-43"></a><a name="newPatExp"><a href="Data.Vector.Unboxed.Deriving.html#newPatExp"><span class="hs-identifier">newPatExp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarP</span><span> </span><span class="hs-operator hs-var">&amp;&amp;&amp;</span><span> </span><span class="hs-identifier hs-var">VarE</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">newName</span><span>
</span><a name="line-44"></a><span>
</span><a name="line-45"></a><span class="hs-keyword">data</span><span> </span><a name="Common"><a href="Data.Vector.Unboxed.Deriving.html#Common"><span class="hs-identifier">Common</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Common"><a href="Data.Vector.Unboxed.Deriving.html#Common"><span class="hs-identifier">Common</span></a></a><span>
</span><a name="line-46"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="mvName"><a href="Data.Vector.Unboxed.Deriving.html#mvName"><span class="hs-identifier">mvName</span></a></a><span class="hs-special">,</span><span> </span><a name="vName"><a href="Data.Vector.Unboxed.Deriving.html#vName"><span class="hs-identifier">vName</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-47"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="i"><a href="Data.Vector.Unboxed.Deriving.html#i"><span class="hs-identifier">i</span></a></a><span class="hs-special">,</span><span> </span><a name="n"><a href="Data.Vector.Unboxed.Deriving.html#n"><span class="hs-identifier">n</span></a></a><span class="hs-special">,</span><span> </span><a name="mv"><a href="Data.Vector.Unboxed.Deriving.html#mv"><span class="hs-identifier">mv</span></a></a><span class="hs-special">,</span><span> </span><a name="mv%27"><a href="Data.Vector.Unboxed.Deriving.html#mv%27"><span class="hs-identifier">mv'</span></a></a><span class="hs-special">,</span><span> </span><a name="v"><a href="Data.Vector.Unboxed.Deriving.html#v"><span class="hs-identifier">v</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-identifier">common</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Q</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#Common"><span class="hs-identifier hs-type">Common</span></a><span>
</span><a name="line-50"></a><a name="common"><a href="Data.Vector.Unboxed.Deriving.html#common"><span class="hs-identifier">common</span></a></a><span> </span><a name="local-6989586621679046681"><a href="#local-6989586621679046681"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-51"></a><span>    </span><span class="hs-comment">-- A bit looser than &#8220;Haskell 2010: &#167;2.4 Identifiers and Operators&#8221;&#8230;</span><span>
</span><a name="line-52"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679046682"><a href="#local-6989586621679046682"><span class="hs-identifier">valid</span></a></a><span> </span><a name="local-6989586621679046683"><a href="#local-6989586621679046683"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679046683"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'_'</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679046683"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'\''</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><a href="#local-6989586621679046683"><span class="hs-identifier hs-var">c</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-char">'#'</span><span> </span><span class="hs-operator hs-var">||</span><span> </span><span class="hs-identifier hs-var">isAlphaNum</span><span> </span><a href="#local-6989586621679046683"><span class="hs-identifier hs-var">c</span></a><span>
</span><a name="line-53"></a><span>    </span><span class="hs-identifier hs-var">unless</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">all</span><span> </span><a href="#local-6989586621679046682"><span class="hs-identifier hs-var">valid</span></a><span> </span><a href="#local-6989586621679046681"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-54"></a><span>        </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679046681"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-operator hs-var">++</span><span> </span><span class="hs-string">&quot; is not a valid constructor suffix!&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-55"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679052833"><a href="#local-6989586621679052833"><span class="hs-identifier">mvName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkName</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;MV_&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679046681"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-56"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679052834"><a href="#local-6989586621679052834"><span class="hs-identifier">vName</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">mkName</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;V_&quot;</span><span> </span><span class="hs-operator hs-var">++</span><span> </span><a href="#local-6989586621679046681"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span>
</span><a name="line-57"></a><span>    </span><a name="local-6989586621679052835"><a href="#local-6989586621679052835"><span class="hs-identifier">i</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#newPatExp"><span class="hs-identifier hs-var">newPatExp</span></a><span> </span><span class="hs-string">&quot;idx&quot;</span><span>
</span><a name="line-58"></a><span>    </span><a name="local-6989586621679052836"><a href="#local-6989586621679052836"><span class="hs-identifier">n</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#newPatExp"><span class="hs-identifier hs-var">newPatExp</span></a><span> </span><span class="hs-string">&quot;len&quot;</span><span>
</span><a name="line-59"></a><span>    </span><a name="local-6989586621679052851"><a href="#local-6989586621679052851"><span class="hs-identifier">mv</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConP</span><span> </span><a href="#local-6989586621679052833"><span class="hs-identifier hs-var">mvName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#newPatExp"><span class="hs-identifier hs-var">newPatExp</span></a><span> </span><span class="hs-string">&quot;mvec&quot;</span><span>
</span><a name="line-60"></a><span>    </span><a name="local-6989586621679052852"><a href="#local-6989586621679052852"><span class="hs-identifier">mv'</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConP</span><span> </span><a href="#local-6989586621679052833"><span class="hs-identifier hs-var">mvName</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#newPatExp"><span class="hs-identifier hs-var">newPatExp</span></a><span> </span><span class="hs-string">&quot;mvec'&quot;</span><span>
</span><a name="line-61"></a><span>    </span><a name="local-6989586621679052853"><a href="#local-6989586621679052853"><span class="hs-identifier">v</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">first</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConP</span><span> </span><a href="#local-6989586621679052834"><span class="hs-identifier hs-var">vName</span></a><span>  </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#newPatExp"><span class="hs-identifier hs-var">newPatExp</span></a><span> </span><span class="hs-string">&quot;vec&quot;</span><span>
</span><a name="line-62"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#Common"><span class="hs-identifier hs-var">Common</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-comment">-- Turn any 'Name' into a capturable one.</span><span>
</span><a name="line-65"></a><span class="hs-identifier">capture</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Name</span><span>
</span><a name="line-66"></a><span class="hs-cpp">#if __GLASGOW_HASKELL__ == 704
</span><span class="hs-identifier">capture</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">mkName</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">nameBase</span><span>
</span><a name="line-68"></a><span class="hs-cpp">#else
</span><a name="capture"><a href="Data.Vector.Unboxed.Deriving.html#capture"><span class="hs-identifier">capture</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-70"></a><span class="hs-cpp">#endif
</span><span>
</span><a name="line-72"></a><span class="hs-identifier">liftE</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Exp</span><span>
</span><a name="line-73"></a><a name="liftE"><a href="Data.Vector.Unboxed.Deriving.html#liftE"><span class="hs-identifier">liftE</span></a></a><span> </span><a name="local-6989586621679052854"><a href="#local-6989586621679052854"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InfixE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679052854"><span class="hs-identifier hs-var">e</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarE</span><span> </span><span class="hs-special">'</span><span class="hs-identifier">liftM</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">Just</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-comment">-- Create a wrapper for the given function with the same 'nameBase', given</span><span>
</span><a name="line-76"></a><span class="hs-comment">-- a list of argument bindings and expressions in terms of said bindings.</span><span>
</span><a name="line-77"></a><span class="hs-comment">-- A final coercion (@Exp &#8594; Exp@) is applied to the body of the function.</span><span>
</span><a name="line-78"></a><span class="hs-comment">-- Complimentary @INLINE@ pragma included.</span><span>
</span><a name="line-79"></a><span class="hs-identifier">wrap</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Name</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier hs-type">Pat</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Exp</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Exp</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Dec</span><span class="hs-special">]</span><span>
</span><a name="line-80"></a><a name="wrap"><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier">wrap</span></a></a><span> </span><a name="local-6989586621679052906"><a href="#local-6989586621679052906"><span class="hs-identifier">fun</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">unzip</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679053094"><a href="#local-6989586621679053094"><span class="hs-identifier">pats</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679053095"><a href="#local-6989586621679053095"><span class="hs-identifier">exps</span></a></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679053096"><a href="#local-6989586621679053096"><span class="hs-identifier">coerce</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679053098"><span class="hs-identifier hs-var">inline</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053100"><span class="hs-identifier hs-var">method</span></a><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-81"></a><span>    </span><a name="local-6989586621679053097"><a href="#local-6989586621679053097"><span class="hs-identifier">name</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#capture"><span class="hs-identifier hs-var">capture</span></a><span> </span><a href="#local-6989586621679052906"><span class="hs-identifier hs-var">fun</span></a><span>
</span><a name="line-82"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,8,0)
</span><span>    </span><a name="local-6989586621679053098"><a href="#local-6989586621679053098"><span class="hs-identifier">inline</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">PragmaD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">InlineP</span><span> </span><a href="#local-6989586621679053097"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-identifier hs-var">Inline</span><span> </span><span class="hs-identifier hs-var">FunLike</span><span> </span><span class="hs-identifier hs-var">AllPhases</span><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span class="hs-cpp">#else
</span><span>    </span><span class="hs-identifier">inline</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">PragmaD</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier">InlineP</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">InlineSpec</span><span> </span><span class="hs-identifier">True</span><span> </span><span class="hs-identifier">False</span><span> </span><span class="hs-identifier">Nothing</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span class="hs-cpp">#endif
</span><span>    </span><a name="local-6989586621679053099"><a href="#local-6989586621679053099"><span class="hs-identifier">body</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621679053096"><span class="hs-identifier hs-var">coerce</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">foldl</span><span> </span><span class="hs-identifier hs-var">AppE</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">VarE</span><span> </span><a href="#local-6989586621679052906"><span class="hs-identifier hs-var">fun</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679053095"><span class="hs-identifier hs-var">exps</span></a><span>
</span><a name="line-88"></a><span>    </span><a name="local-6989586621679053100"><a href="#local-6989586621679053100"><span class="hs-identifier">method</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FunD</span><span> </span><a href="#local-6989586621679053097"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">Clause</span><span> </span><a href="#local-6989586621679053094"><span class="hs-identifier hs-var">pats</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NormalB</span><span> </span><a href="#local-6989586621679053099"><span class="hs-identifier hs-var">body</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><a name="line-89"></a><span>
</span><a name="line-90"></a><span class="hs-comment">{-| Let's consider a more complex example: suppose we want an @Unbox@
instance for @Maybe a@. We could encode this using the pair @(Bool, a)@,
with the boolean indicating whether we have @Nothing@ or @Just@ something.
This encoding requires a dummy value in the @Nothing@ case, necessitating an
additional &lt;http://hackage.haskell.org/package/data-default/docs/Data-Default.html#t:Default Default&gt;
constraint. Thus:

&gt;derivingUnbox &quot;Maybe&quot;
&gt;    [t| &#8704; a. (Default a, Unbox a) &#8658; Maybe a &#8594; (Bool, a) |]
&gt;    [| maybe (False, def) (\ x &#8594; (True, x)) |]
&gt;    [| \ (b, x) &#8594; if b then Just x else Nothing |]
-}</span><span>
</span><a name="line-102"></a><span class="hs-identifier">derivingUnbox</span><span>
</span><a name="line-103"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">String</span><span>   </span><span class="hs-comment">-- ^ Unique constructor suffix for the MVector and Vector data families</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TypeQ</span><span>    </span><span class="hs-comment">-- ^ Quotation of the form @[t| /ctxt/ &#8658; src &#8594; rep |]@</span><span>
</span><a name="line-105"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>     </span><span class="hs-comment">-- ^ Quotation of an expression of type @src &#8594; rep@</span><span>
</span><a name="line-106"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ExpQ</span><span>     </span><span class="hs-comment">-- ^ Quotation of an expression of type @rep &#8594; src@</span><span>
</span><a name="line-107"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">DecsQ</span><span>    </span><span class="hs-comment">-- ^ Declarations to be spliced for the derived Unbox instance</span><span>
</span><a name="line-108"></a><a name="derivingUnbox"><a href="Data.Vector.Unboxed.Deriving.html#derivingUnbox"><span class="hs-identifier">derivingUnbox</span></a></a><span> </span><a name="local-6989586621679053101"><a href="#local-6989586621679053101"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679053102"><a href="#local-6989586621679053102"><span class="hs-identifier">argsQ</span></a></a><span> </span><a name="local-6989586621679053103"><a href="#local-6989586621679053103"><span class="hs-identifier">toRepQ</span></a></a><span> </span><a name="local-6989586621679053104"><a href="#local-6989586621679053104"><span class="hs-identifier">fromRepQ</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-109"></a><span>    </span><a href="Data.Vector.Unboxed.Deriving.html#Common"><span class="hs-identifier hs-var">Common</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#common"><span class="hs-identifier hs-var">common</span></a><span> </span><a href="#local-6989586621679053101"><span class="hs-identifier hs-var">name</span></a><span>
</span><a name="line-110"></a><span>    </span><a name="local-6989586621679053112"><a href="#local-6989586621679053112"><span class="hs-identifier">toRep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679053103"><span class="hs-identifier hs-var">toRepQ</span></a><span>
</span><a name="line-111"></a><span>    </span><a name="local-6989586621679053113"><a href="#local-6989586621679053113"><span class="hs-identifier">fromRep</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679053104"><span class="hs-identifier hs-var">fromRepQ</span></a><span>
</span><a name="line-112"></a><span>    </span><a name="local-6989586621679053114"><a href="#local-6989586621679053114"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">second</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppE</span><span> </span><a href="#local-6989586621679053112"><span class="hs-identifier hs-var">toRep</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#newPatExp"><span class="hs-identifier hs-var">newPatExp</span></a><span> </span><span class="hs-string">&quot;val&quot;</span><span>
</span><a name="line-113"></a><span>    </span><a name="local-6989586621679053115"><a href="#local-6989586621679053115"><span class="hs-identifier">args</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679053102"><span class="hs-identifier hs-var">argsQ</span></a><span>
</span><a name="line-114"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679053121"><a href="#local-6989586621679053121"><span class="hs-identifier">cxts</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679053122"><a href="#local-6989586621679053122"><span class="hs-identifier">typ</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679053123"><a href="#local-6989586621679053123"><span class="hs-identifier">rep</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621679053115"><span class="hs-identifier hs-var">args</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-115"></a><span>        </span><span class="hs-identifier hs-var">ForallT</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679053116"><a href="#local-6989586621679053116"><span class="hs-identifier">cxts</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ArrowT</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a name="local-6989586621679053117"><a href="#local-6989586621679053117"><span class="hs-identifier">typ</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a name="local-6989586621679053118"><a href="#local-6989586621679053118"><span class="hs-identifier">rep</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679053116"><span class="hs-identifier hs-var">cxts</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053117"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053118"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-116"></a><span>        </span><span class="hs-identifier hs-var">ArrowT</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a name="local-6989586621679053119"><a href="#local-6989586621679053119"><span class="hs-identifier">typ</span></a></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a name="local-6989586621679053120"><a href="#local-6989586621679053120"><span class="hs-identifier">rep</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053119"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053120"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">fail</span><span> </span><span class="hs-string">&quot;Expecting a type of the form: cxts =&gt; typ -&gt; rep&quot;</span><span>
</span><a name="line-118"></a><span>
</span><a name="line-119"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053124"><a href="#local-6989586621679053124"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">VarT</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">mkName</span><span> </span><span class="hs-string">&quot;s&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-120"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,11,0)
</span><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053125"><a href="#local-6989586621679053125"><span class="hs-identifier">lazy</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Bang</span><span> </span><span class="hs-identifier hs-var">NoSourceUnpackedness</span><span> </span><span class="hs-identifier hs-var">NoSourceStrictness</span><span>
</span><a name="line-122"></a><span class="hs-cpp"># define MAYBE_KIND Nothing
# define MAYBE_OVERLAP Nothing
#else
</span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">lazy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">NotStrict</span><span>
</span><a name="line-126"></a><span class="hs-cpp"># define MAYBE_KIND
# define MAYBE_OVERLAP
#endif
#if MIN_VERSION_template_haskell(2,15,0)
</span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">newtypeMVector</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">NewtypeInstD</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">MVector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">AppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">AppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">typ</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">MAYBE_KIND</span><span>
</span><a name="line-131"></a><span class="hs-cpp">#else
</span><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053126"><a href="#local-6989586621679053126"><span class="hs-identifier">newtypeMVector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NewtypeInstD</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">MVector</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679053124"><span class="hs-identifier hs-var">s</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053122"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier">MAYBE_KIND</span><span>
</span><a name="line-133"></a><span class="hs-cpp">#endif
</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NormalC</span><span> </span><a href="#local-6989586621679053105"><span class="hs-identifier hs-var">mvName</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679053125"><span class="hs-identifier hs-var">lazy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">MVector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679053124"><span class="hs-identifier hs-var">s</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679053123"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-135"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053127"><a href="#local-6989586621679053127"><span class="hs-identifier">mvCon</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ConE</span><span> </span><a href="#local-6989586621679053105"><span class="hs-identifier hs-var">mvName</span></a><span>
</span><a name="line-136"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053128"><a href="#local-6989586621679053128"><span class="hs-identifier">instanceMVector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InstanceD</span><span> </span><span class="hs-identifier">MAYBE_OVERLAP</span><span> </span><span class="hs-identifier">cxts</span><span>
</span><a name="line-137"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">M.MVector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">MVector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679053122"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-138"></a><span>            </span><span class="hs-special">[</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicLength</span><span>           </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">]</span><span>        </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-139"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicUnsafeSlice</span><span>      </span><span class="hs-special">[</span><a href="#local-6989586621679053107"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">]</span><span>  </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppE</span><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-var">mvCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicOverlaps</span><span>         </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053110"><span class="hs-identifier hs-var">mv'</span></a><span class="hs-special">]</span><span>   </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-141"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicUnsafeNew</span><span>        </span><span class="hs-special">[</span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span>         </span><span class="hs-special">(</span><a href="Data.Vector.Unboxed.Deriving.html#liftE"><span class="hs-identifier hs-var">liftE</span></a><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-var">mvCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-142"></a><span class="hs-cpp">#if MIN_VERSION_vector(0,11,0)
</span><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicInitialize</span><span>       </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">]</span><span>        </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-144"></a><span class="hs-cpp">#endif
</span><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicUnsafeReplicate</span><span>  </span><span class="hs-special">[</span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053114"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>      </span><span class="hs-special">(</span><a href="Data.Vector.Unboxed.Deriving.html#liftE"><span class="hs-identifier hs-var">liftE</span></a><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-var">mvCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicUnsafeRead</span><span>       </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053107"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">]</span><span>     </span><span class="hs-special">(</span><a href="Data.Vector.Unboxed.Deriving.html#liftE"><span class="hs-identifier hs-var">liftE</span></a><span> </span><a href="#local-6989586621679053113"><span class="hs-identifier hs-var">fromRep</span></a><span class="hs-special">)</span><span>
</span><a name="line-147"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicUnsafeWrite</span><span>      </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053107"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053114"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>  </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-148"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicClear</span><span>            </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">]</span><span>        </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-149"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicSet</span><span>              </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053114"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>     </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-150"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicUnsafeCopy</span><span>       </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053110"><span class="hs-identifier hs-var">mv'</span></a><span class="hs-special">]</span><span>   </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-151"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicUnsafeMove</span><span>       </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053110"><span class="hs-identifier hs-var">mv'</span></a><span class="hs-special">]</span><span>   </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-152"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">M.basicUnsafeGrow</span><span>       </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">]</span><span>     </span><span class="hs-special">(</span><a href="Data.Vector.Unboxed.Deriving.html#liftE"><span class="hs-identifier hs-var">liftE</span></a><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-var">mvCon</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-153"></a><span>
</span><a name="line-154"></a><span class="hs-cpp">#if MIN_VERSION_template_haskell(2,15,0)
</span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">newtypeVector</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">NewtypeInstD</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">AppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">typ</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">MAYBE_KIND</span><span>
</span><a name="line-156"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier">NormalC</span><span> </span><span class="hs-identifier">vName</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">lazy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">AppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">rep</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-157"></a><span class="hs-cpp">#else
</span><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053161"><a href="#local-6989586621679053161"><span class="hs-identifier">newtypeVector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">NewtypeInstD</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621679053122"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">]</span><span> </span><span class="hs-identifier">MAYBE_KIND</span><span>
</span><a name="line-159"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">NormalC</span><span> </span><a href="#local-6989586621679053106"><span class="hs-identifier hs-var">vName</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-6989586621679053125"><span class="hs-identifier hs-var">lazy</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679053123"><span class="hs-identifier hs-var">rep</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-160"></a><span class="hs-cpp">#endif
</span><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053162"><a href="#local-6989586621679053162"><span class="hs-identifier">vCon</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">ConE</span><span> </span><a href="#local-6989586621679053106"><span class="hs-identifier hs-var">vName</span></a><span>
</span><a name="line-162"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679053163"><a href="#local-6989586621679053163"><span class="hs-identifier">instanceVector</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">InstanceD</span><span> </span><span class="hs-identifier">MAYBE_OVERLAP</span><span> </span><span class="hs-identifier">cxts</span><span>
</span><a name="line-163"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">G.Vector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier hs-var">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Vector</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-var">AppT</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679053122"><span class="hs-identifier hs-var">typ</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span>
</span><a name="line-164"></a><span>            </span><span class="hs-special">[</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">G.basicUnsafeFreeze</span><span>     </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">]</span><span>        </span><span class="hs-special">(</span><a href="Data.Vector.Unboxed.Deriving.html#liftE"><span class="hs-identifier hs-var">liftE</span></a><span> </span><a href="#local-6989586621679053162"><span class="hs-identifier hs-var">vCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">G.basicUnsafeThaw</span><span>       </span><span class="hs-special">[</span><a href="#local-6989586621679053111"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>         </span><span class="hs-special">(</span><a href="Data.Vector.Unboxed.Deriving.html#liftE"><span class="hs-identifier hs-var">liftE</span></a><span> </span><a href="#local-6989586621679053127"><span class="hs-identifier hs-var">mvCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">G.basicLength</span><span>           </span><span class="hs-special">[</span><a href="#local-6989586621679053111"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>         </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-167"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">G.basicUnsafeSlice</span><span>      </span><span class="hs-special">[</span><a href="#local-6989586621679053107"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var">n</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053111"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AppE</span><span> </span><a href="#local-6989586621679053162"><span class="hs-identifier hs-var">vCon</span></a><span class="hs-special">)</span><span>
</span><a name="line-168"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">G.basicUnsafeIndexM</span><span>     </span><span class="hs-special">[</span><a href="#local-6989586621679053111"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053107"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">]</span><span>      </span><span class="hs-special">(</span><a href="Data.Vector.Unboxed.Deriving.html#liftE"><span class="hs-identifier hs-var">liftE</span></a><span> </span><a href="#local-6989586621679053113"><span class="hs-identifier hs-var">fromRep</span></a><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">G.basicUnsafeCopy</span><span>       </span><span class="hs-special">[</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">mv</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053111"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">]</span><span>     </span><span class="hs-identifier hs-var">id</span><span>
</span><a name="line-170"></a><span>            </span><span class="hs-special">,</span><span> </span><a href="Data.Vector.Unboxed.Deriving.html#wrap"><span class="hs-identifier hs-var">wrap</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier">G.elemseq</span><span>               </span><span class="hs-special">[</span><a href="#local-6989586621679053111"><span class="hs-identifier hs-var">v</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053114"><span class="hs-identifier hs-var">a</span></a><span class="hs-special">]</span><span>      </span><span class="hs-identifier hs-var">id</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-identifier hs-var">InstanceD</span><span> </span><span class="hs-identifier">MAYBE_OVERLAP</span><span> </span><span class="hs-identifier hs-var">cxts</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ConT</span><span> </span><span class="hs-special">''</span><span class="hs-identifier hs-var">Unbox</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">AppT</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">typ</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-173"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053126"><span class="hs-identifier hs-var">newtypeMVector</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053128"><span class="hs-identifier hs-var">instanceMVector</span></a><span>
</span><a name="line-174"></a><span>        </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053161"><span class="hs-identifier hs-var">newtypeVector</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679053163"><span class="hs-identifier hs-var">instanceVector</span></a><span> </span><span class="hs-special">]</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-cpp">#undef __GLASGOW_HASKELL__
</span><span class="hs-comment">{-$usage

Writing @Unbox@ instances for new data types is tedious and formulaic. More
often than not, there is a straightforward mapping of the new type onto some
existing one already imbued with an @Unbox@ instance. The
&lt;http://hackage.haskell.org/package/vector/docs/Data-Vector-Unboxed.html example&gt;
from the @vector@ package represents @Complex a@ as pairs @(a, a)@. Using
'derivingUnbox', we can define the same instances much more succinctly:

&gt;derivingUnbox &quot;Complex&quot;
&gt;    [t| &#8704; a. (Unbox a) &#8658; Complex a &#8594; (a, a) |]
&gt;    [| \ (r :+ i) &#8594; (r, i) |]
&gt;    [| \ (r, i) &#8594; r :+ i |]

Requires the @MultiParamTypeClasses@, @TemplateHaskell@, @TypeFamilies@ and
probably the @FlexibleInstances@ @LANGUAGE@ extensions. Note that GHC 7.4
(but not earlier nor later) needs the 'G.Vector' and 'M.MVector' class
method names to be in scope in order to define the appropriate instances:

&gt;#if __GLASGOW_HASKELL__ == 704
&gt;import qualified Data.Vector.Generic
&gt;import qualified Data.Vector.Generic.Mutable
&gt;#endif

Consult the &lt;https://github.com/liyang/vector-th-unbox/blob/master/tests/sanity.hs sanity test&gt;
for a working example.

-}</span><span>
</span><a name="line-205"></a></pre></body></html>